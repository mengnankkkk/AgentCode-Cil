# é˜¶æ®µ4 - Rustè¿ç§»é¡¾é—®ï¼ˆFR-11ï¼‰å¯è¡Œæ€§åˆ†æ

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

**å¯è¡Œæ€§è¯„çº§**: ğŸŸ¢ **é«˜åº¦å¯è¡Œ**ï¼ˆ90%ï¼‰

**å…³é”®ç»“è®º**:
- âœ… æ‰€æœ‰å¿…éœ€çš„åŸºç¡€è®¾æ–½å·²å°±ä½ï¼ˆPhase 3ï¼‰
- âœ… CLIå‘½ä»¤æ¡†æ¶å·²é¢„ç•™å®ç°ä½ç½®
- âœ… å¯ç›´æ¥å¤ç”¨ç°æœ‰ç»„ä»¶ï¼ˆCodeSlicerã€PromptBuilderï¼‰
- âš ï¸ éœ€è¦é€‚é…APIæ¥å£ï¼ˆç”¨æˆ·ç¤ºä¾‹ä»£ç ä¸å®é™…å®ç°æœ‰å·®å¼‚ï¼‰
- ğŸ¯ **å»ºè®®ç«‹å³å®æ–½**ï¼Œé¢„è®¡2-3å°æ—¶å®Œæˆ

---

## 1. éœ€æ±‚åˆ†æ

### 1.1 ç›®æ ‡æ¦‚è¿°

å®ç°"è¯Šæ–­ä¸‰"å»ºè®®çš„C-to-Rust FFIè¿ç§»é¡¾é—®ï¼Œé€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªä»»åŠ¡ï¼š

| ä»»åŠ¡ | æè¿° | å¤æ‚åº¦ | æ—¶é—´ä¼°ç®— |
|------|------|--------|----------|
| **T4.1** | å¢å¼ºPromptBuilder.buildRustFFIPrompt() | ğŸŸ¢ ç®€å• | 10åˆ†é’Ÿ |
| **T4.2** | å®ç°RustMigrationAdvisor.java | ğŸŸ¡ ä¸­ç­‰ | 60åˆ†é’Ÿ |
| **T4.3** | é›†æˆåˆ°RefactorCommand.handleRustMigration() | ğŸŸ¢ ç®€å• | 30åˆ†é’Ÿ |

### 1.2 åŠŸèƒ½éœ€æ±‚

**è¾“å…¥**:
- Cæºæ–‡ä»¶è·¯å¾„ï¼ˆ`-f`/`--file`ï¼‰
- å‡½æ•°æ‰€åœ¨è¡Œå·ï¼ˆ`-l`/`--line`ï¼‰

**è¾“å‡º**:
Markdownæ ¼å¼çš„Rustè¿ç§»å»ºè®®ï¼ŒåŒ…å«ï¼š
1. æ ¸å¿ƒåŠŸèƒ½æè¿°
2. æƒ¯ç”¨Rusté‡å†™
3. å…³é”®è¿ç§»æŒ‘æˆ˜ï¼ˆé”™è¯¯å¤„ç†ã€å†…å­˜ç®¡ç†ã€ç±»å‹æ˜ å°„ï¼‰
4. FFIå®‰å…¨åŒ…è£…å™¨ï¼ˆå¯é€‰ï¼‰

**è°ƒç”¨æ–¹å¼**:
```bash
harmony-agent refactor <source-path> --type rust-migration -f bzlib.c -l 234
```

---

## 2. æ¶æ„å…¼å®¹æ€§åˆ†æ

### 2.1 âœ… å·²æœ‰åŸºç¡€è®¾æ–½ï¼ˆPhase 3å®Œæˆï¼‰

#### CodeSlicer
- **ä½ç½®**: `src/main/java/com/harmony/agent/core/ai/CodeSlicer.java`
- **åŠŸèƒ½**: æå–å‡½æ•°çº§ä»£ç ä¸Šä¸‹æ–‡
- **æ¥å£**:
```java
public String getContextSlice(Path file, int lineNumber)
```
- **çŠ¶æ€**: âœ… å·²å®ç°å¹¶æµ‹è¯•

#### PromptBuilder
- **ä½ç½®**: `src/main/java/com/harmony/agent/core/ai/PromptBuilder.java`
- **å½“å‰æ–¹æ³•**:
  - `buildIssueValidationPrompt()`
  - `buildRustFFIPrompt()` - âš ï¸ **å·²å­˜åœ¨ä½†æœªå®ç°**
  - `buildCodeQualityPrompt()`
- **æ‰©å±•éš¾åº¦**: ğŸŸ¢ æä½ï¼Œç›´æ¥æ·»åŠ å®ç°å³å¯

#### LLMProvideræ¶æ„
- **æ ¸å¿ƒæ¥å£**:
```java
public interface LLMProvider {
    LLMResponse sendRequest(LLMRequest request);
    String getProviderName();
    boolean isAvailable();
}
```
- **å·²æœ‰å®ç°**:
  - `OpenAIProvider` (OpenAI GPTæ¨¡å‹)
  - `ClaudeProvider` (Anthropic Claudeæ¨¡å‹)
- **å·¥å‚æ¨¡å¼**: `ProviderFactory.createDefault()`
- **çŠ¶æ€**: âœ… æ¶æ„å®Œæ•´ä¸”ç¨³å®š

#### Request/Responseæ¨¡å‹
```java
// LLMRequest - Builderæ¨¡å¼
LLMRequest request = LLMRequest.builder()
    .model("gpt-4")
    .temperature(0.5)
    .maxTokens(3000)
    .addSystemMessage("You are an expert...")
    .addUserMessage(prompt)
    .build();

// LLMResponse
response.getContent()        // Markdownæ–‡æœ¬
response.getTotalTokens()    // Tokenä½¿ç”¨ç»Ÿè®¡
response.isSuccess()         // è¯·æ±‚çŠ¶æ€
```

### 2.2 âœ… CLIå‘½ä»¤æ¡†æ¶

#### RefactorCommandåˆ†æ
- **ä½ç½®**: `src/main/java/com/harmony/agent/cli/RefactorCommand.java`
- **å…³é”®å‘ç°**:
  - âœ… å‘½ä»¤å·²å­˜åœ¨ï¼ˆpicocliæ¡†æ¶ï¼‰
  - âœ… å·²æ”¯æŒ`--type rust-migration`é€‰é¡¹
  - âœ… `handleRustMigration()`æ–¹æ³•å·²é¢„ç•™ï¼ˆRefactorCommand.java:98-144ï¼‰
  - âš ï¸ **å½“å‰æ˜¯TODOå®ç°ï¼Œéœ€è¦æ›¿æ¢ä¸ºçœŸå®é€»è¾‘**

**ç°æœ‰TODOå®ç°**:
```java
private int handleRustMigration(ConsolePrinter printer) throws InterruptedException {
    // TODO: Phase 4 - Implement Rust migration suggestions
    printer.spinner("Generating Rust migration advice...", false);
    Thread.sleep(1500);
    printer.spinner("Generating Rust migration advice", true);

    // ... é™æ€ç¤ºä¾‹è¾“å‡º ...
}
```

**éœ€è¦ä¿®æ”¹**:
1. æ·»åŠ `-f/--file`å’Œ`-l/--line`é€‰é¡¹
2. å®ä¾‹åŒ–`RustMigrationAdvisor`
3. è°ƒç”¨`getMigrationSuggestion()`
4. è¾“å‡ºMarkdownå»ºè®®

#### ConsolePrinterè¾“å‡ºAPI
- **å¯ç”¨æ–¹æ³•**:
  - `printer.header()` - å¤§æ ‡é¢˜
  - `printer.subheader()` - å°æ ‡é¢˜
  - `printer.info()` - ä¿¡æ¯
  - `printer.success()`/`warning()`/`error()` - çŠ¶æ€æ¶ˆæ¯
  - `printer.keyValue()` - é”®å€¼å¯¹
  - `System.out.println()` - ç›´æ¥è¾“å‡ºï¼ˆç”¨äºMarkdownä»£ç å—ï¼‰

---

## 3. å®ç°æ–¹æ¡ˆè®¾è®¡

### 3.1 æ¨èæ¶æ„ï¼šç›´æ¥ä½¿ç”¨LLMProvider

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | æ¨èåº¦ |
|------|------|------|--------|
| **A. å¤ç”¨AiValidationClient** | ä¿æŒæ¶æ„ä¸€è‡´ | ä¸ºJSONè®¾è®¡ï¼ˆæ¸©åº¦0.3ï¼‰ï¼Œä¸é€‚åˆå¼€æ”¾å¼ç”Ÿæˆ | ğŸŸ¡ ä¸æ¨è |
| **B. åˆ›å»ºGeneralAiClient** | çµæ´»é…ç½®ï¼Œæ”¯æŒå¤šåœºæ™¯ | å¢åŠ æ¶æ„å¤æ‚åº¦ | ğŸŸ¢ å¯é€‰ |
| **C. ç›´æ¥ä½¿ç”¨LLMProvider** | ç®€å•ç›´æ¥ï¼Œå‡å°‘å°è£…å±‚ | ç¼ºå°‘ç»Ÿä¸€ç¼“å­˜ | ğŸŸ¢ğŸŸ¢ **å¼ºçƒˆæ¨è** |

**æ¨èæ–¹æ¡ˆC**çš„ç†ç”±ï¼š
1. Rustè¿ç§»å»ºè®®æ˜¯**é«˜çº§å’¨è¯¢åŠŸèƒ½**ï¼Œä¸éœ€è¦ä¸¥æ ¼çš„JSONéªŒè¯
2. æ¯æ¬¡å»ºè®®éƒ½åº”è¯¥æ–°é²œç”Ÿæˆï¼Œç¼“å­˜ä»·å€¼è¾ƒä½
3. å‡å°‘ä¸å¿…è¦çš„æŠ½è±¡å±‚ï¼Œä¿æŒä»£ç ç®€æ´
4. æ¸©åº¦è®¾ç½®ä¸º0.5-0.7æ›´é€‚åˆåˆ›æ„æ€§å»ºè®®

### 3.2 T4.1: å¢å¼ºPromptBuilder

**å®ç°ä½ç½®**: `PromptBuilder.java`ï¼ˆå·²æœ‰å ä½ï¼‰

**è¯¦ç»†å®ç°**:
```java
/**
 * Rust FFIè¿ç§»å»ºè®®æç¤ºè¯
 * @param codeSlice Cå‡½æ•°ä»£ç ç‰‡æ®µ
 * @return ç»“æ„åŒ–æç¤ºè¯
 */
public static String buildRustFFIPrompt(String codeSlice) {
    return String.format(
        """
        You are an expert in C-to-Rust migration and FFI (Foreign Function Interface).
        Analyze the following C function:

        ```c
        %s
        ```

        Provide a detailed migration analysis. Structure your response clearly using Markdown.
        Your response MUST include the following sections:

        1.  **Core Responsibility**: Briefly describe the primary purpose of this C function.
        2.  **Idiomatic Rust Rewrite**: Provide an idiomatic, safe Rust function that *replaces* the C code's logic.
        3.  **Key Migration Challenges**:
            * **Error Handling**: How are C error codes (e.g., return values, errno) mapped to Rust `Result` or `Option`?
            * **Memory Management**: Explain how C's manual `malloc`/`free` or pointer parameters map to Rust's ownership model (e.g., `Vec<u8>`, `String`, `Box`).
            * **Type Mapping**: How do C types (e.g., `char*`, `void*`, structs) map to Rust types?
        4.  **FFI Safety Wrapper** (Optional): If a full rewrite is too complex, provide an `extern "C"` Rust function that acts as a *safe wrapper* around the original C code.

        Focus on practical, actionable advice. Use clear Rust code examples with comments.
        """,
        codeSlice
    );
}
```

**ä¿®æ”¹ç‚¹**:
- âœ… å ä½æ–¹æ³•å·²å­˜åœ¨ï¼ˆPromptBuilder.java:60-72ï¼‰
- åªéœ€å¡«å……å®ç°é€»è¾‘

### 3.3 T4.2: å®ç°RustMigrationAdvisor

**æ–°æ–‡ä»¶**: `src/main/java/com/harmony/agent/core/ai/RustMigrationAdvisor.java`

**æ¶æ„è®¾è®¡**:
```java
package com.harmony.agent.core.ai;

import com.harmony.agent.llm.model.LLMRequest;
import com.harmony.agent.llm.model.LLMResponse;
import com.harmony.agent.llm.provider.LLMProvider;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.nio.file.Path;

public class RustMigrationAdvisor {
    private static final Logger logger = LoggerFactory.getLogger(RustMigrationAdvisor.class);

    // Rustè¿ç§»éœ€è¦æ›´é«˜çš„æ¸©åº¦ä»¥æ”¯æŒåˆ›é€ æ€§å»ºè®®
    private static final double RUST_MIGRATION_TEMPERATURE = 0.5;
    private static final int RUST_MIGRATION_MAX_TOKENS = 3000;

    private final LLMProvider llmProvider;
    private final CodeSlicer codeSlicer;
    private final String model;

    /**
     * æ„é€ å‡½æ•°
     * @param llmProvider LLMæä¾›è€…ï¼ˆOpenAIæˆ–Claudeï¼‰
     * @param codeSlicer ä»£ç åˆ‡ç‰‡å™¨ï¼ˆå¤ç”¨Phase 3ï¼‰
     * @param model æ¨¡å‹åç§°ï¼ˆå¦‚"gpt-4"ï¼‰
     */
    public RustMigrationAdvisor(LLMProvider llmProvider, CodeSlicer codeSlicer, String model) {
        this.llmProvider = llmProvider;
        this.codeSlicer = codeSlicer;
        this.model = model;

        logger.info("RustMigrationAdvisor initialized with provider: {}, model: {}",
            llmProvider.getProviderName(), model);
    }

    /**
     * è·å–Rustè¿ç§»å»ºè®®
     * @param file Cæºæ–‡ä»¶è·¯å¾„
     * @param lineNumber å‡½æ•°æ‰€åœ¨è¡Œå·
     * @return Markdownæ ¼å¼çš„è¿ç§»å»ºè®®
     */
    public String getMigrationSuggestion(Path file, int lineNumber) {
        logger.info("Generating Rust migration suggestion for: {}:{}", file, lineNumber);

        try {
            // 1. ä½¿ç”¨CodeSliceræå–ä»£ç ä¸Šä¸‹æ–‡
            String codeSlice = codeSlicer.getContextSlice(file, lineNumber);
            if (codeSlice.startsWith("[Error:")) {
                return "âŒ Error: " + codeSlice;
            }

            // 2. ä½¿ç”¨PromptBuilderæ„å»ºæç¤ºè¯
            String prompt = PromptBuilder.buildRustFFIPrompt(codeSlice);

            // 3. æ„å»ºLLMè¯·æ±‚
            LLMRequest request = LLMRequest.builder()
                .model(model)
                .temperature(RUST_MIGRATION_TEMPERATURE)
                .maxTokens(RUST_MIGRATION_MAX_TOKENS)
                .addSystemMessage(
                    "You are an expert Rust engineer specializing in C-to-Rust migration and FFI. " +
                    "Provide clear, practical, and actionable advice. " +
                    "Always include concrete Rust code examples with detailed comments."
                )
                .addUserMessage(prompt)
                .build();

            // 4. å‘é€è¯·æ±‚
            LLMResponse response = llmProvider.sendRequest(request);

            // 5. æ£€æŸ¥å“åº”
            if (!response.isSuccess()) {
                logger.error("LLM request failed: {}", response.getErrorMessage());
                return "âŒ Error: Failed to generate migration suggestion - " + response.getErrorMessage();
            }

            logger.info("Migration suggestion generated successfully ({} tokens)",
                response.getTotalTokens());

            return response.getContent();

        } catch (Exception e) {
            logger.error("Failed to generate Rust migration suggestion", e);
            return "âŒ Error: " + e.getMessage();
        }
    }

    /**
     * æ£€æŸ¥LLMæä¾›è€…æ˜¯å¦å¯ç”¨
     */
    public boolean isAvailable() {
        return llmProvider.isAvailable();
    }
}
```

**å…³é”®è®¾è®¡ç‚¹**:
- âœ… ç›´æ¥ä½¿ç”¨LLMProvideræ¥å£ï¼ˆé¿å…è¿‡åº¦å°è£…ï¼‰
- âœ… æ¸©åº¦è®¾ç½®ä¸º0.5ï¼ˆå¹³è¡¡åˆ›é€ æ€§å’Œå‡†ç¡®æ€§ï¼‰
- âœ… Tokené™åˆ¶3000ï¼ˆè¶³å¤Ÿè¯¦ç»†çš„å»ºè®®ï¼‰
- âœ… å¤ç”¨CodeSlicerå’ŒPromptBuilder
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 3.4 T4.3: é›†æˆåˆ°RefactorCommand

**ä¿®æ”¹æ–‡ä»¶**: `src/main/java/com/harmony/agent/cli/RefactorCommand.java`

**Step 1**: æ·»åŠ æ–°é€‰é¡¹
```java
@Option(
    names = {"-f", "--file"},
    description = "Source file for Rust migration analysis"
)
private String targetFile;

@Option(
    names = {"-l", "--line"},
    description = "Line number in the file"
)
private Integer lineNumber;
```

**Step 2**: ä¿®æ”¹handleRustMigration()æ–¹æ³•
```java
private int handleRustMigration(ConsolePrinter printer) {
    try {
        // éªŒè¯å‚æ•°
        if (targetFile == null || lineNumber == null) {
            printer.error("Rust migration requires --file and --line options");
            printer.info("Example: refactor <path> --type rust-migration -f bzlib.c -l 234");
            return 1;
        }

        // éªŒè¯æ–‡ä»¶å­˜åœ¨
        Path filePath = Paths.get(sourcePath).resolve(targetFile);
        if (!Files.exists(filePath)) {
            printer.error("File not found: " + filePath);
            return 1;
        }

        // åˆå§‹åŒ–ç»„ä»¶
        ConfigManager configManager = parent.getConfigManager();

        // åˆ›å»ºLLMProvider
        String openaiKey = System.getenv("OPENAI_API_KEY");
        if (openaiKey == null || openaiKey.isEmpty()) {
            openaiKey = configManager.getConfig().getAi().getApiKey();
        }

        String claudeKey = System.getenv("CLAUDE_API_KEY");
        ProviderFactory factory = ProviderFactory.createDefault(openaiKey, claudeKey);

        String providerName = configManager.getConfig().getAi().getProvider();
        LLMProvider provider = factory.getProvider(providerName);

        if (!provider.isAvailable()) {
            printer.error("LLM provider not available. Please configure API keys.");
            return 1;
        }

        // åˆ›å»ºRustMigrationAdvisor
        CodeSlicer codeSlicer = new CodeSlicer();
        String model = configManager.getConfig().getAi().getModel();
        RustMigrationAdvisor advisor = new RustMigrationAdvisor(provider, codeSlicer, model);

        // æ˜¾ç¤ºåˆ†æå¼€å§‹
        printer.header("Rust Migration Analysis");
        printer.info("File: " + targetFile);
        printer.info("Line: " + lineNumber);
        printer.info("Provider: " + provider.getProviderName());
        printer.blank();

        // ç”Ÿæˆå»ºè®®
        printer.spinner("Analyzing C code and generating Rust migration advice...", false);
        String suggestion = advisor.getMigrationSuggestion(filePath, lineNumber);
        printer.spinner("Analysis complete", true);

        printer.blank();

        // è¾“å‡ºå»ºè®®
        if (suggestion.startsWith("âŒ")) {
            printer.error(suggestion);
            return 1;
        } else {
            System.out.println(suggestion);
            printer.blank();
            printer.success("Migration suggestion generated successfully");
            return 0;
        }

    } catch (Exception e) {
        printer.error("Failed to generate Rust migration suggestion: " + e.getMessage());
        if (parent.isVerbose()) {
            e.printStackTrace();
        }
        return 1;
    }
}
```

**ä¿®æ”¹èŒƒå›´**:
- âœ… æ›¿æ¢RefactorCommand.java:98-144çš„TODOå®ç°
- âœ… æ·»åŠ -få’Œ-lé€‰é¡¹åˆ°ç±»å­—æ®µ
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„æç¤º

---

## 4. APIæ¥å£é€‚é…é—®é¢˜

### 4.1 ç”¨æˆ·ç¤ºä¾‹ä»£ç çš„é—®é¢˜

**ç”¨æˆ·æä¾›çš„ç¤ºä¾‹**:
```java
private final LlmProvider llmProvider; // âŒ é”™è¯¯ï¼šç±»å‹åå°å†™
LlmProvider.LLMRequest request = new LlmProvider.LLMRequest(prompt, 0.5, false); // âŒ é”™è¯¯ï¼šæ„é€ å‡½æ•°ä¸å­˜åœ¨
LlmProvider.LLMResponse response = llmProvider.sendRequest(request); // âŒ é”™è¯¯ï¼šç±»å‹åé”™è¯¯
```

### 4.2 æ­£ç¡®çš„å®ç°

```java
// âœ… æ­£ç¡®ï¼šæ¥å£åæ˜¯LLMProviderï¼ˆå…¨å¤§å†™ï¼‰
private final LLMProvider llmProvider;
private final CodeSlicer codeSlicer;

// âœ… æ­£ç¡®ï¼šä½¿ç”¨Builderæ¨¡å¼
LLMRequest request = LLMRequest.builder()
    .model("gpt-4")
    .temperature(0.5)
    .maxTokens(3000)
    .addSystemMessage("You are an expert...")
    .addUserMessage(prompt)
    .build();

// âœ… æ­£ç¡®ï¼šè°ƒç”¨sendRequest
LLMResponse response = llmProvider.sendRequest(request);
String markdownContent = response.getContent();
```

### 4.3 å…³é”®å·®å¼‚å¯¹ç…§è¡¨

| ç”¨æˆ·ç¤ºä¾‹ | å®é™…API | ä¿®æ­£ç†ç”± |
|----------|---------|----------|
| `LlmProvider` | `LLMProvider` | æ¥å£å‘½åéµå¾ªJavaå‘½åè§„èŒƒï¼ˆé¦–å­—æ¯å¤§å†™ç¼©å†™ï¼‰ |
| `new LlmProvider.LLMRequest(...)` | `LLMRequest.builder()...` | ä½¿ç”¨Builderæ¨¡å¼ï¼Œä¸æ˜¯ç›´æ¥æ„é€ å‡½æ•° |
| ç¬¬3ä¸ªå‚æ•°`expectJson` | ä¸å­˜åœ¨æ­¤å‚æ•° | JSONæ¨¡å¼é€šè¿‡ç³»ç»Ÿæ¶ˆæ¯æ§åˆ¶ï¼Œä¸åœ¨Requestä¸­ |
| `LlmProvider.LLMResponse` | `LLMResponse` | Responseæ˜¯ç‹¬ç«‹ç±»ï¼Œä¸æ˜¯å†…éƒ¨ç±» |

---

## 5. é£é™©è¯„ä¼°ä¸ç¼“è§£

### 5.1 æŠ€æœ¯é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ | çŠ¶æ€ |
|------|------|------|----------|------|
| LLM APIé…ç½®é”™è¯¯ | ä½ | ä¸­ | å®Œå–„é”™è¯¯æç¤ºï¼Œæ£€æŸ¥APIå¯†é’¥å¯ç”¨æ€§ | âœ… å·²è§„åˆ’ |
| CodeSliceræå–å¤±è´¥ | ä½ | ä½ | å·²æœ‰fallbackæœºåˆ¶ï¼ˆÂ±10è¡Œä¸Šä¸‹æ–‡ï¼‰ | âœ… å·²å®ç° |
| æç¤ºè¯è´¨é‡ä¸ä½³ | ä¸­ | ä¸­ | å‚è€ƒç”¨æˆ·æä¾›çš„é«˜è´¨é‡æ¨¡æ¿ï¼ŒåŒ…å«few-shot | âœ… å·²è§„åˆ’ |
| Markdownè¾“å‡ºæ ¼å¼æ··ä¹± | ä½ | ä½ | åœ¨ç³»ç»Ÿæ¶ˆæ¯ä¸­æ˜ç¡®è¦æ±‚ç»“æ„åŒ–è¾“å‡º | âœ… å·²è§„åˆ’ |
| Tokenè¶…é™ | ä½ | ä½ | è®¾ç½®maxTokens=3000ï¼Œç›‘æ§ä½¿ç”¨æƒ…å†µ | âœ… å·²è§„åˆ’ |

### 5.2 æ¶æ„é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ | çŠ¶æ€ |
|------|------|------|----------|------|
| è¿‡åº¦å°è£…å¯¼è‡´å¤æ‚åº¦å¢åŠ  | ä½ | ä¸­ | é€‰æ‹©æ–¹æ¡ˆCï¼ˆç›´æ¥ä½¿ç”¨LLMProviderï¼‰ | âœ… å·²å†³ç­– |
| ä¸ç°æœ‰ä»£ç å†²çª | æä½ | ä½ | RefactorCommandå·²é¢„ç•™å®ç°ä½ç½® | âœ… æ— å†²çª |
| ä¾èµ–ç®¡ç†é—®é¢˜ | æä½ | ä½ | æ‰€æœ‰ä¾èµ–å·²åœ¨Phase 3æ·»åŠ  | âœ… æ— æ–°ä¾èµ– |

### 5.3 ç”¨æˆ·ä½“éªŒé£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ | çŠ¶æ€ |
|------|------|------|----------|------|
| å‘½ä»¤è¡Œå‚æ•°å¤æ‚ | ä½ | ä½ | æä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºå’Œä½¿ç”¨ç¤ºä¾‹ | âœ… å·²è§„åˆ’ |
| AIå“åº”æ—¶é—´è¿‡é•¿ | ä¸­ | ä¸­ | æ·»åŠ spinneråŠ¨ç”»ï¼Œæ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆ..." | âœ… å·²è§„åˆ’ |
| å»ºè®®è´¨é‡ä¸ç¨³å®š | ä¸­ | é«˜ | ä½¿ç”¨æ¸©åº¦0.5å¹³è¡¡ï¼Œæ·»åŠ é«˜è´¨é‡ç³»ç»Ÿæç¤º | âœ… å·²è§„åˆ’ |

---

## 6. ä¾èµ–æ£€æŸ¥æ¸…å•

### 6.1 Phase 3ä¾èµ–ï¼ˆå·²å®Œæˆï¼‰

- [x] **CodeSlicer.java** - ä»£ç åˆ‡ç‰‡å™¨
- [x] **PromptBuilder.java** - æç¤ºè¯æ„å»ºå™¨ï¼ˆæœ‰å ä½ï¼‰
- [x] **LLMProvideræ¥å£** - LLMæä¾›è€…æŠ½è±¡
- [x] **LLMRequest/LLMResponse** - è¯·æ±‚/å“åº”æ¨¡å‹
- [x] **ProviderFactory** - æä¾›è€…å·¥å‚
- [x] **OpenAIProvider** - OpenAIå®ç°
- [x] **ClaudeProvider** - Claudeå®ç°

### 6.2 æ–°å¢ä¾èµ–ï¼ˆæ— ï¼‰

**ä¼˜åŠ¿**: æ— éœ€æ·»åŠ æ–°çš„Mavenä¾èµ–ï¼Œæ‰€æœ‰å¿…éœ€åº“å·²åœ¨Phase 3å¼•å…¥ã€‚

### 6.3 é…ç½®ä¾èµ–

**éœ€è¦çš„é…ç½®**:
```yaml
# config.yaml
ai:
  provider: "openai"  # æˆ– "claude"
  model: "gpt-4"      # æˆ– "gpt-3.5-turbo" / "claude-3-sonnet"
  api_key: "sk-..."   # å¯é€‰ï¼Œä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡
```

**ç¯å¢ƒå˜é‡**ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰:
- `OPENAI_API_KEY`
- `CLAUDE_API_KEY`

---

## 7. æµ‹è¯•ç­–ç•¥

### 7.1 å•å…ƒæµ‹è¯•

**RustMigrationAdvisorTest.java**:
```java
@Test
void testGetMigrationSuggestion_Success() {
    // Mock LLMProvider
    LLMProvider mockProvider = mock(LLMProvider.class);
    when(mockProvider.sendRequest(any()))
        .thenReturn(LLMResponse.builder()
            .content("## Core Responsibility\n...")
            .success(true)
            .build());

    // Test
    RustMigrationAdvisor advisor = new RustMigrationAdvisor(
        mockProvider, new CodeSlicer(), "gpt-4"
    );
    String result = advisor.getMigrationSuggestion(testFile, 10);

    // Verify
    assertThat(result).contains("Core Responsibility");
    verify(mockProvider).sendRequest(argThat(req ->
        req.getTemperature() == 0.5 && req.getMaxTokens() == 3000
    ));
}

@Test
void testGetMigrationSuggestion_CodeSlicerFailure() {
    // Test error handling when CodeSlicer fails
}

@Test
void testGetMigrationSuggestion_LLMFailure() {
    // Test error handling when LLM request fails
}
```

### 7.2 é›†æˆæµ‹è¯•

**RefactorCommandIntegrationTest.java**:
```java
@Test
void testRustMigrationCommand_EndToEnd() {
    // Setup test file
    Path testFile = createTestCFile();

    // Execute command
    int exitCode = new CommandLine(new HarmonyAgentCLI())
        .execute("refactor", testFile.getParent().toString(),
                 "--type", "rust-migration",
                 "-f", testFile.getFileName().toString(),
                 "-l", "10");

    // Verify
    assertEquals(0, exitCode);
    assertThat(outputCapture.toString())
        .contains("Core Responsibility")
        .contains("Idiomatic Rust Rewrite");
}
```

### 7.3 æ‰‹åŠ¨æµ‹è¯•åœºæ™¯

1. **æ­£å¸¸æµç¨‹**:
   ```bash
   harmony-agent refactor /path/to/bzip2 --type rust-migration -f bzlib.c -l 234
   ```

2. **é”™è¯¯å¤„ç†**:
   - ç¼ºå°‘-fæˆ–-lå‚æ•°
   - æ–‡ä»¶ä¸å­˜åœ¨
   - APIå¯†é’¥æœªé…ç½®
   - LLMæœåŠ¡ä¸å¯ç”¨

3. **è¾¹ç•Œæƒ…å†µ**:
   - ç¬¬ä¸€è¡Œçš„å‡½æ•°
   - æœ€åä¸€è¡Œçš„å‡½æ•°
   - åµŒå¥—å‡½æ•°
   - å®å®šä¹‰

---

## 8. å®æ–½æ—¶é—´ä¼°ç®—

### 8.1 ä»»åŠ¡åˆ†è§£

| é˜¶æ®µ | ä»»åŠ¡ | æ—¶é—´ | ä¾èµ– |
|------|------|------|------|
| **Phase 1** | T4.1: å®ç°buildRustFFIPrompt() | 10åˆ†é’Ÿ | æ—  |
| | å•å…ƒæµ‹è¯• | 5åˆ†é’Ÿ | T4.1 |
| **Phase 2** | T4.2: åˆ›å»ºRustMigrationAdvisor.java | 30åˆ†é’Ÿ | T4.1 |
| | å•å…ƒæµ‹è¯• | 20åˆ†é’Ÿ | T4.2 |
| **Phase 3** | T4.3: ä¿®æ”¹RefactorCommand | 20åˆ†é’Ÿ | T4.2 |
| | é›†æˆæµ‹è¯• | 15åˆ†é’Ÿ | T4.3 |
| **Phase 4** | æ‰‹åŠ¨æµ‹è¯•å’Œè°ƒè¯• | 30åˆ†é’Ÿ | All |
| | æ–‡æ¡£æ›´æ–° | 15åˆ†é’Ÿ | All |
| **æ€»è®¡** | | **2å°æ—¶25åˆ†é’Ÿ** | |

### 8.2 å…³é”®è·¯å¾„

```
T4.1 (10min) â†’ T4.2 (30min) â†’ T4.3 (20min) â†’ æµ‹è¯• (45min) â†’ æ–‡æ¡£ (15min)
æ€»è®¡: 2å°æ—¶20åˆ†é’Ÿ
```

**å¹¶è¡Œæœºä¼š**:
- T4.1å®Œæˆåï¼Œå•å…ƒæµ‹è¯•å’ŒT4.2å¼€å‘å¯éƒ¨åˆ†å¹¶è¡Œ
- T4.2å’ŒT4.3çš„æµ‹è¯•ç¼–å†™å¯å¹¶è¡Œ

---

## 9. æˆåŠŸæ ‡å‡†

### 9.1 åŠŸèƒ½éªŒæ”¶æ ‡å‡†

- [ ] å‘½ä»¤`harmony-agent refactor <path> --type rust-migration -f <file> -l <line>`èƒ½å¤ŸæˆåŠŸæ‰§è¡Œ
- [ ] è¾“å‡ºåŒ…å«4ä¸ªå¿…éœ€éƒ¨åˆ†ï¼šæ ¸å¿ƒåŠŸèƒ½ã€Rusté‡å†™ã€è¿ç§»æŒ‘æˆ˜ã€FFIåŒ…è£…å™¨
- [ ] è¾“å‡ºæ ¼å¼ä¸ºåˆæ³•çš„Markdownï¼Œå¯è¯»æ€§è‰¯å¥½
- [ ] é”™è¯¯åœºæ™¯æœ‰æ¸…æ™°çš„é”™è¯¯æç¤º
- [ ] æ”¯æŒOpenAIå’ŒClaudeä¸¤ç§æä¾›è€…

### 9.2 è´¨é‡æ ‡å‡†

- [ ] ä»£ç è¦†ç›–ç‡ > 80%ï¼ˆå•å…ƒæµ‹è¯•ï¼‰
- [ ] æ— SonarQubeä¸¥é‡é—®é¢˜
- [ ] æ—¥å¿—è®°å½•å®Œæ•´ï¼ˆINFOçº§åˆ«ç”¨äºæ­£å¸¸æµç¨‹ï¼ŒERRORçº§åˆ«ç”¨äºå¼‚å¸¸ï¼‰
- [ ] ç¬¦åˆé¡¹ç›®ä»£ç é£æ ¼ï¼ˆéµå¾ªç°æœ‰å‘½åå’Œç»“æ„ï¼‰

### 9.3 æ€§èƒ½æ ‡å‡†

- [ ] CodeSlicerå“åº”æ—¶é—´ < 100ms
- [ ] LLMè¯·æ±‚è¶…æ—¶è®¾ç½®åˆç†ï¼ˆå»ºè®®60ç§’ï¼‰
- [ ] æ€»å“åº”æ—¶é—´ < 90ç§’ï¼ˆå«LLMå¤„ç†ï¼‰

### 9.4 ç”¨æˆ·ä½“éªŒæ ‡å‡†

- [ ] å‘½ä»¤è¡Œå‚æ•°æ¸…æ™°ç›´è§‚
- [ ] é”™è¯¯æ¶ˆæ¯å‹å¥½ä¸”å¯æ“ä½œ
- [ ] è¿›åº¦åé¦ˆåŠæ—¶ï¼ˆspinneråŠ¨ç”»ï¼‰
- [ ] è¾“å‡ºæ ¼å¼è§„èŒƒï¼Œæ˜“äºå¤åˆ¶

---

## 10. åç»­ä¼˜åŒ–æ–¹å‘

### 10.1 çŸ­æœŸä¼˜åŒ–ï¼ˆPhase 4.1ï¼‰

1. **ç¼“å­˜æ”¯æŒ**:
   - ä¸ºç›¸åŒå‡½æ•°çš„å»ºè®®æ·»åŠ ç¼“å­˜ï¼ˆåŸºäºæ–‡ä»¶è·¯å¾„+è¡Œå·å“ˆå¸Œï¼‰
   - é¢„è®¡èŠ‚çœ30-50%çš„APIæˆæœ¬

2. **æ‰¹é‡åˆ†æ**:
   - æ”¯æŒä¸€æ¬¡æ€§åˆ†æå¤šä¸ªå‡½æ•°
   - å‘½ä»¤ï¼š`refactor <path> --type rust-migration --batch functions.txt`

3. **é…ç½®ä¼˜åŒ–**:
   - æ”¯æŒè‡ªå®šä¹‰æ¸©åº¦å’Œtokené™åˆ¶
   - æ”¯æŒé€‰æ‹©ä¸åŒçš„LLMæ¨¡å‹

### 10.2 ä¸­æœŸå¢å¼ºï¼ˆPhase 4.2ï¼‰

1. **äº¤äº’å¼æ¨¡å¼**:
   - ç”¨æˆ·å¯å¯¹AIå»ºè®®æé—®
   - æ”¯æŒå¤šè½®å¯¹è¯æ”¹è¿›å»ºè®®

2. **ä»£ç ç”Ÿæˆ**:
   - è‡ªåŠ¨ç”ŸæˆRustä»£ç æ–‡ä»¶
   - ç”ŸæˆFFIç»‘å®šä»£ç 

3. **è´¨é‡è¯„åˆ†**:
   - å¯¹Cä»£ç çš„è¿ç§»éš¾åº¦æ‰“åˆ†
   - è¯„ä¼°è¿ç§»åçš„å®‰å…¨æ€§æ”¹è¿›

### 10.3 é•¿æœŸæ„¿æ™¯ï¼ˆPhase 5+ï¼‰

1. **å…¨é¡¹ç›®åˆ†æ**:
   - æ‰«ææ•´ä¸ªCé¡¹ç›®ï¼Œç”Ÿæˆå®Œæ•´çš„Rustè¿ç§»è·¯çº¿å›¾
   - è¯†åˆ«è¿ç§»ä¼˜å…ˆçº§ï¼ˆé«˜é£é™©å‡½æ•°ä¼˜å…ˆï¼‰

2. **å¢é‡è¿ç§»å·¥å…·**:
   - ç”ŸæˆFFIæ¡¥æ¥ä»£ç ï¼Œæ”¯æŒCå’ŒRustæ··åˆç¼–è¯‘
   - è‡ªåŠ¨åŒ–æµ‹è¯•è¿ç§»å‰åçš„åŠŸèƒ½ä¸€è‡´æ€§

3. **å­¦ä¹ ä¼˜åŒ–**:
   - åŸºäºç”¨æˆ·åé¦ˆæ”¹è¿›æç¤ºè¯
   - ç§¯ç´¯å¸¸è§è¿ç§»æ¨¡å¼åº“

---

## 11. æ¨èå†³ç­–

### 11.1 ç«‹å³å®æ–½å»ºè®®

âœ… **å¼ºçƒˆæ¨èç«‹å³å®æ–½**ï¼Œç†ç”±ï¼š

1. **æŠ€æœ¯å¯è¡Œæ€§æé«˜**ï¼ˆ90%ï¼‰
   - æ‰€æœ‰åŸºç¡€è®¾æ–½å®Œå¤‡
   - æ— æ–°å¢ä¾èµ–
   - APIæ¥å£æ¸…æ™°

2. **å•†ä¸šä»·å€¼æ˜ç¡®**
   - è§£å†³å®é™…ç—›ç‚¹ï¼ˆCä»£ç å®‰å…¨æ€§é—®é¢˜ï¼‰
   - æä¾›å¯è½åœ°çš„è¿ç§»å»ºè®®
   - ç¬¦åˆRustç”Ÿæ€è¶‹åŠ¿

3. **é£é™©å¯æ§**
   - å®æ–½æ—¶é—´çŸ­ï¼ˆ2-3å°æ—¶ï¼‰
   - æ”¹åŠ¨èŒƒå›´å°ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰
   - ä¸å½±å“ç°æœ‰åŠŸèƒ½

4. **ç”¨æˆ·ä½“éªŒä¼˜ç§€**
   - CLIå‘½ä»¤æ¡†æ¶å·²å°±ç»ª
   - è¾“å‡ºæ ¼å¼ä¸“ä¸šï¼ˆMarkdownï¼‰
   - é”™è¯¯å¤„ç†å®Œå–„

### 11.2 å®æ–½è·¯å¾„

**æ¨èé‡‡ç”¨æ¸è¿›å¼å®æ–½**ï¼š

```
Day 1 Morning: T4.1 + T4.2 (æ ¸å¿ƒé€»è¾‘)
Day 1 Afternoon: T4.3 + å•å…ƒæµ‹è¯•
Day 2 Morning: é›†æˆæµ‹è¯• + æ‰‹åŠ¨éªŒè¯
Day 2 Afternoon: æ–‡æ¡£ + å‘å¸ƒ
```

### 11.3 å…³é”®æ³¨æ„äº‹é¡¹

1. **APIé€‚é…**:
   - âš ï¸ ä¸¥æ ¼æŒ‰ç…§å®é™…LLMProvideræ¥å£å®ç°
   - âš ï¸ ä¸è¦ä½¿ç”¨ç”¨æˆ·ç¤ºä¾‹ä»£ç çš„é”™è¯¯API

2. **é”™è¯¯å¤„ç†**:
   - âœ… æ£€æŸ¥APIå¯†é’¥å¯ç”¨æ€§
   - âœ… å¤„ç†CodeSlicerå¤±è´¥åœºæ™¯
   - âœ… å¤„ç†LLMè¯·æ±‚å¤±è´¥

3. **ç”¨æˆ·ä½“éªŒ**:
   - âœ… æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º
   - âœ… æ·»åŠ spinneråŠ¨ç”»åé¦ˆ
   - âœ… è¾“å‡ºæ ¼å¼åŒ–çš„Markdown

---

## 12. é™„å½•

### 12.1 ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | ä½œç”¨ |
|----------|------|------|
| `src/main/java/com/harmony/agent/core/ai/PromptBuilder.java` | ä¿®æ”¹ | æ·»åŠ buildRustFFIPrompt()å®ç° |
| `src/main/java/com/harmony/agent/core/ai/RustMigrationAdvisor.java` | æ–°å»º | æ ¸å¿ƒè¿ç§»å»ºè®®æœåŠ¡ |
| `src/main/java/com/harmony/agent/cli/RefactorCommand.java` | ä¿®æ”¹ | æ›¿æ¢handleRustMigration()å®ç° |
| `src/test/java/com/harmony/agent/core/ai/RustMigrationAdvisorTest.java` | æ–°å»º | å•å…ƒæµ‹è¯• |
| `src/test/java/com/harmony/agent/cli/RefactorCommandIntegrationTest.java` | ä¿®æ”¹ | é›†æˆæµ‹è¯• |

### 12.2 APIè°ƒç”¨ç¤ºä¾‹

```java
// å®Œæ•´çš„è°ƒç”¨é“¾ç¤ºä¾‹
Path file = Paths.get("/path/to/bzlib.c");
int line = 234;

// 1. åˆ›å»ºç»„ä»¶
ProviderFactory factory = ProviderFactory.createDefault(openaiKey, claudeKey);
LLMProvider provider = factory.getProvider("openai");
CodeSlicer slicer = new CodeSlicer();
RustMigrationAdvisor advisor = new RustMigrationAdvisor(provider, slicer, "gpt-4");

// 2. ç”Ÿæˆå»ºè®®
String markdown = advisor.getMigrationSuggestion(file, line);

// 3. è¾“å‡ºç»“æœ
System.out.println(markdown);
```

### 12.3 é¢„æœŸè¾“å‡ºç¤ºä¾‹

```markdown
## Core Responsibility

This function performs in-place decompression of bzip2-compressed data...

## Idiomatic Rust Rewrite

```rust
use std::io::{self, Read, Write};

pub fn decompress_bzip2(input: &[u8]) -> Result<Vec<u8>, io::Error> {
    // Rust ownership ensures memory safety
    let mut decompressor = bzip2::Decompress::new(false);
    let mut output = Vec::new();

    decompressor.decompress_vec(input, &mut output)?;
    Ok(output)
}
```

## Key Migration Challenges

### Error Handling
- **C approach**: Return codes (0 = success, negative = error)
- **Rust approach**: `Result<Vec<u8>, io::Error>`
  - Eliminates need to check return values
  - Compiler enforces error handling

...
```

---

## 13. ç»“è®º

**å¯è¡Œæ€§è¯„çº§**: ğŸŸ¢ **é«˜åº¦å¯è¡Œ**ï¼ˆ90%ï¼‰

**æ ¸å¿ƒä¼˜åŠ¿**:
1. âœ… æŠ€æœ¯æ ˆå®Œæ•´ï¼Œæ— ç¼ºå¤±ç»„ä»¶
2. âœ… CLIæ¡†æ¶å·²é¢„ç•™å®ç°ä½ç½®
3. âœ… å¯ç›´æ¥å¤ç”¨Phase 3æˆæœ
4. âœ… å®æ–½æ—¶é—´çŸ­ï¼Œé£é™©å¯æ§

**å”¯ä¸€æ³¨æ„äº‹é¡¹**:
- âš ï¸ å¿…é¡»ä½¿ç”¨å®é™…LLMProvider APIï¼ˆä¸æ˜¯ç”¨æˆ·ç¤ºä¾‹ä»£ç ï¼‰
- âš ï¸ éœ€è¦æ­£ç¡®é…ç½®APIå¯†é’¥

**æ¨èè¡ŒåŠ¨**:
ğŸš€ **ç«‹å³å¼€å§‹å®æ–½**ï¼ŒæŒ‰T4.1 â†’ T4.2 â†’ T4.3çš„é¡ºåºæ¸è¿›å®Œæˆã€‚

---

**åˆ†ææ—¥æœŸ**: 2025-10-18
**åˆ†æè€…**: Claude Code
**ç‰ˆæœ¬**: 1.0
