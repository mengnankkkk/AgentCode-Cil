# T2.4 ä¸é˜¶æ®µ3å¯è¡Œæ€§åˆ†æ

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

| ä»»åŠ¡ | å¯è¡Œæ€§ | å½“å‰çŠ¶æ€ | å…³é”®é£é™© |
|------|--------|----------|----------|
| T2.4-Refactor | âœ… é«˜åº¦å¯è¡Œ | âœ… å·²å®Œæˆ | æ— é‡å¤§é£é™© |
| T3.1 LlmClient | âœ… é«˜åº¦å¯è¡Œ | â³ å¾…å®æ–½ | APIå¯†é’¥ç®¡ç† |
| T3.2 CachedLlmClient | âœ… é«˜åº¦å¯è¡Œ | â³ å¾…å®æ–½ | å†…å­˜ä½¿ç”¨ |
| T3.3 CodeSlicer | âš ï¸ ä¸­ç­‰éš¾åº¦ | â³ å¾…å®æ–½ | C/C++è§£æå‡†ç¡®æ€§ |
| T3.4 PromptBuilder | âœ… é«˜åº¦å¯è¡Œ | â³ å¾…å®æ–½ | æç¤ºè¯è´¨é‡ |
| T3.5 DecisionEngine | âœ… é«˜åº¦å¯è¡Œ | â³ å¾…å®æ–½ | AIå“åº”å¯é æ€§ |

---

## ç¬¬1éƒ¨åˆ†ï¼šT2.4-Refactor å¯è¡Œæ€§åˆ†æ

### âœ… å½“å‰å®æ–½çŠ¶å†µ

**å·²å®Œæˆçš„å·¥ä½œï¼š**

1. âœ… **æ„é€ å‡½æ•°æ³¨å…¥ExecutorService**
   - æ–‡ä»¶ï¼š`ClangAnalyzer.java:58`
   - å®ç°ï¼š4ä¸ªé‡è½½æ„é€ å‡½æ•°ï¼Œæœ€ç»ˆæ„é€ å‡½æ•°æ¥å—ExecutorService
   ```java
   public ClangAnalyzer(String clangPath, String compileCommandsPath, ExecutorService executorService)
   ```

2. âœ… **AnalysisEngineä¼ é€’çº¿ç¨‹æ± **
   - æ–‡ä»¶ï¼š`AnalysisEngine.java:55-59`
   - å®ç°ï¼šåœ¨`initializeAnalyzers()`ä¸­ä¼ é€’`this.executorService`

3. âœ… **æ–¹æ³•é‡æ„**
   - `analyze(Path file)` â†’ å§”æ‰˜ç»™ `analyzeSingleFile(Path file)` (ClangAnalyzer.java:103)
   - `analyzeAll(List<Path> files)` â†’ å®ç°å¹¶è¡Œé€»è¾‘ (ClangAnalyzer.java:108)

4. âœ… **å¹¶è¡Œæ‰§è¡Œå®ç°**
   - æ–‡ä»¶ï¼š`ClangAnalyzer.java:128-164`
   - æ–¹æ³•ï¼š`analyzeParallel(List<Path> files)`
   - ä½¿ç”¨ï¼š`ExecutorService.invokeAll()` + `Future.get()`

### ğŸ”„ å®ç°å·®å¼‚åˆ†æ

| æ–¹é¢ | ç”¨æˆ·éœ€æ±‚ | å½“å‰å®ç° | è¯„ä¼° |
|------|----------|----------|------|
| **ä»»åŠ¡åˆ›å»º** | `Callable<Void>` + CopyOnWriteArrayList | `Callable<List<SecurityIssue>>` + æ”¶é›†Futureç»“æœ | âœ… ä¸¤è€…éƒ½å¯è¡Œï¼Œå½“å‰å®ç°æ›´å‡½æ•°å¼ |
| **å¼‚å¸¸å¤„ç†** | åœ¨Callableä¸­æ•è· | åœ¨Future.get()ä¸­æ•è·ExecutionException | âœ… å½“å‰å®ç°æ›´ç»†è‡´ |
| **æ—¥å¿—çº§åˆ«** | æœªæŒ‡å®š | ä½¿ç”¨debugçº§åˆ«è®°å½•å•æ–‡ä»¶ï¼Œinfoè®°å½•æ•´ä½“ | âœ… æ›´åˆç†çš„æ—¥å¿—åˆ†çº§ |
| **é¡ºåºå›é€€** | æœªæåŠ | å®ç°äº†`analyzeSequential()`å›é€€ | âœ… å¢å¼ºäº†å¥å£®æ€§ |

### ğŸ“Š æ€§èƒ½é¢„æœŸ

**ç†è®ºåŠ é€Ÿæ¯”ï¼š**
```
å‡è®¾ï¼š
- N = 100ä¸ªCæ–‡ä»¶
- T_clang = å¹³å‡2ç§’/æ–‡ä»¶
- Threads = 8

ä¸²è¡Œè€—æ—¶ï¼š100 Ã— 2s = 200s
å¹¶è¡Œè€—æ—¶ï¼š(100/8) Ã— 2s â‰ˆ 25s
åŠ é€Ÿæ¯”ï¼š200/25 = 8x
```

**å®é™…å› ç´ ï¼š**
- âœ… IOå¯†é›†å‹ä»»åŠ¡ï¼Œé€‚åˆå¹¶è¡Œ
- âš ï¸ Clang-Tidyè‡ªèº«çš„å¯åŠ¨å¼€é”€
- âš ï¸ æ–‡ä»¶ç³»ç»Ÿå¹¶å‘è¯»å–é™åˆ¶

### âœ… ç»“è®ºï¼šT2.4å·²æˆåŠŸå®ç°

**å½“å‰å®ç°ä¼˜äºéœ€æ±‚æ–‡æ¡£çš„åœ°æ–¹ï¼š**
1. æä¾›äº†é¡ºåºæ‰§è¡Œå›é€€æœºåˆ¶
2. æ›´ç»†è‡´çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—
3. ä½¿ç”¨`Callable<List<SecurityIssue>>`é¿å…å…±äº«çŠ¶æ€

**ç¼–è¯‘éªŒè¯ï¼š** âœ… PASSED (mvn compile)

---

## ç¬¬2éƒ¨åˆ†ï¼šé˜¶æ®µ3 - AIå¢å¼ºåˆ†æå¯è¡Œæ€§

### T3.1: LlmClient.java

**å¯è¡Œæ€§ï¼š** âœ… é«˜åº¦å¯è¡Œ

**æŠ€æœ¯æ ˆéªŒè¯ï¼š**
- âœ… OkHttp: æˆç†Ÿçš„HTTPå®¢æˆ·ç«¯
- âœ… Gson: å·²åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ (ClangAnalyzer.java:6)
- âœ… OpenAIå…¼å®¹API: æ ‡å‡†åŒ–æ¥å£

**å…³é”®è®¾è®¡å†³ç­–ï¼š**

| å†³ç­–ç‚¹ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|--------|----------|------|
| APIè¶…æ—¶ | 60ç§’ | LLMå“åº”é€šå¸¸åœ¨5-30ç§’ |
| é”™è¯¯é‡è¯• | æ˜¯ï¼Œæœ€å¤š3æ¬¡ | æé«˜å¯é æ€§ |
| æµå¼å“åº” | å¦ | ç®€åŒ–å®ç°ï¼Œæ‰¹é‡å¤„ç† |
| å“åº”éªŒè¯ | JSON SchemaéªŒè¯ | é¿å…è§£æé”™è¯¯ |

**æ½œåœ¨é£é™©ï¼š**
1. âš ï¸ **APIå¯†é’¥æ³„éœ²**
   - ç¼“è§£ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸æäº¤åˆ°Git
   - éªŒè¯ï¼šåœ¨`.gitignore`ä¸­æ’é™¤é…ç½®æ–‡ä»¶

2. âš ï¸ **è´¹ç”¨æ§åˆ¶**
   - ç¼“è§£ï¼šT3.2çš„ç¼“å­˜æœºåˆ¶
   - å»ºè®®ï¼šæ·»åŠ è¯·æ±‚è®¡æ•°å’Œæˆæœ¬ä¼°ç®—æ—¥å¿—

3. âš ï¸ **ç½‘ç»œæ•…éšœ**
   - ç¼“è§£ï¼šå®ç°é‡è¯•æœºåˆ¶å’Œè¶…æ—¶
   - å»ºè®®ï¼šé™çº§åˆ°ä»…é™æ€åˆ†æ

**æ¨èæ”¹è¿›ï¼š**
```java
// æ·»åŠ é‡è¯•é€»è¾‘
private static final int MAX_RETRIES = 3;
private static final long RETRY_DELAY_MS = 1000;

public String sendRequest(String prompt, boolean expectJson) throws IOException {
    IOException lastException = null;
    for (int attempt = 0; attempt < MAX_RETRIES; attempt++) {
        try {
            return sendRequestInternal(prompt, expectJson);
        } catch (IOException e) {
            lastException = e;
            if (attempt < MAX_RETRIES - 1) {
                logger.warn("LLM request failed (attempt {}/{}), retrying...",
                    attempt + 1, MAX_RETRIES);
                Thread.sleep(RETRY_DELAY_MS * (attempt + 1));
            }
        }
    }
    throw lastException;
}
```

### T3.2: CachedLlmClient.java

**å¯è¡Œæ€§ï¼š** âœ… é«˜åº¦å¯è¡Œ

**ä¾èµ–æ£€æŸ¥ï¼š**
```xml
<!-- éœ€è¦åœ¨pom.xmlä¸­æ·»åŠ  -->
<dependency>
    <groupId>com.google.guava</groupId>
    <artifactId>guava</artifactId>
    <version>33.0.0-jre</version>
</dependency>
```

**ç¼“å­˜ç­–ç•¥åˆ†æï¼š**

| æŒ‡æ ‡ | é…ç½®å€¼ | ç†ç”± |
|------|--------|------|
| æœ€å¤§æ¡ç›®æ•° | 500 | å‡è®¾å¹³å‡æç¤ºè¯5KBï¼Œæ€»å†…å­˜â‰ˆ2.5MB |
| è¿‡æœŸæ—¶é—´ | 24å°æ—¶ | å¹³è¡¡æ–°é²œåº¦å’Œå‘½ä¸­ç‡ |
| é©±é€ç­–ç•¥ | LRU (Guavaé»˜è®¤) | ä¿ç•™çƒ­ç‚¹æ•°æ® |

**å†…å­˜ä¼°ç®—ï¼š**
```
å‡è®¾åœºæ™¯ï¼š
- åˆ†æ1000ä¸ªæ–‡ä»¶
- 50%éœ€è¦AIéªŒè¯ = 500æ¬¡è¯·æ±‚
- ç¼“å­˜å‘½ä¸­ç‡30% (é‡å¤çš„æ¼æ´æ¨¡å¼)
- å®é™…LLMè°ƒç”¨ = 500 Ã— 0.7 = 350æ¬¡

æˆæœ¬èŠ‚çº¦ï¼š
- ä¸ä½¿ç”¨ç¼“å­˜ï¼š500 Ã— $0.0001 = $0.05
- ä½¿ç”¨ç¼“å­˜ï¼š350 Ã— $0.0001 = $0.035
- èŠ‚çº¦30%
```

**æ½œåœ¨é—®é¢˜ï¼š**
1. âš ï¸ **ç¼“å­˜é”®å†²çª**
   - é—®é¢˜ï¼šä¸åŒä¸Šä¸‹æ–‡ä½†ç›¸åŒæç¤ºè¯
   - è§£å†³ï¼šå°†ä»£ç åˆ‡ç‰‡å“ˆå¸Œå€¼ä¹ŸåŠ å…¥ç¼“å­˜é”®
   ```java
   String cacheKey = prompt + "#" + Integer.toHexString(codeSlice.hashCode());
   ```

2. âš ï¸ **å†…å­˜æ³„æ¼**
   - é—®é¢˜ï¼šé•¿æœŸè¿è¡Œçš„æœåŠ¡å™¨
   - è§£å†³ï¼šGuavaçš„`expireAfterWrite`å·²å¤„ç†

### T3.3: CodeSlicer.java

**å¯è¡Œæ€§ï¼š** âš ï¸ ä¸­ç­‰éš¾åº¦

**æŠ€æœ¯æŒ‘æˆ˜ï¼š**

| æŒ‘æˆ˜ | å¤æ‚åº¦ | è§£å†³æ–¹æ¡ˆ |
|------|--------|----------|
| å‡½æ•°ç­¾åè¯†åˆ« | ğŸ”´ é«˜ | ä½¿ç”¨ç®€åŒ–çš„æ­£åˆ™è¡¨è¾¾å¼ + å¯å‘å¼è§„åˆ™ |
| èŠ±æ‹¬å·åŒ¹é… | ğŸŸ¡ ä¸­ | çŠ¶æ€æœºè·Ÿè¸ªåµŒå¥—å±‚çº§ |
| é¢„å¤„ç†å™¨æŒ‡ä»¤ | ğŸŸ¡ ä¸­ | è·³è¿‡`#if`/`#endif`æˆ–åŒ…å«å®ƒä»¬ |
| æ¨¡æ¿/å®å±•å¼€ | ğŸ”´ é«˜ | **ä¸å¤„ç†**ï¼Œä¾èµ–åŸå§‹ä»£ç  |

**å½“å‰è®¾è®¡è¯„ä¼°ï¼š**

**âœ… ä¼˜ç‚¹ï¼š**
1. ç®€å•é«˜æ•ˆï¼Œæ— éœ€å®Œæ•´è§£æå™¨
2. å¤„ç†å¤§å¤šæ•°å¸¸è§Cå‡½æ•°
3. æœ‰åˆç†çš„å›é€€æœºåˆ¶ï¼ˆÂ±10/20è¡Œï¼‰

**âš ï¸ å±€é™æ€§ï¼š**
1. **å¤æ‚å‡½æ•°ç­¾å**
   ```c
   static inline __attribute__((always_inline))
   int* complex_func(void) {  // å¯èƒ½æ— æ³•è¯†åˆ«
   ```

2. **Lambda/åµŒå¥—å‡½æ•°**
   ```c
   void outer() {
       void inner() {  // å¯èƒ½å¯¼è‡´åˆ‡ç‰‡é”™è¯¯
           // ...
       }
   }
   ```

3. **å®å®šä¹‰çš„å‡½æ•°**
   ```c
   #define FUNC(x) void func_##x() { ... }
   FUNC(test)  // æ— æ³•è¯†åˆ«
   ```

**æ”¹è¿›å»ºè®®ï¼š**
```java
// æ›´å¥å£®çš„å‡½æ•°ç­¾åæ£€æµ‹
private static final Pattern FUNCTION_PATTERN = Pattern.compile(
    "^[a-zA-Z_][a-zA-Z0-9_*\\s]*\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*\\([^)]*\\)\\s*\\{?$"
);

// æ£€æµ‹æ—¶è€ƒè™‘å¤šè¡Œå‡½æ•°ç­¾å
private int findFunctionStart(List<String> lines, int issueLineIndex) {
    for (int i = issueLineIndex; i >= 0; i--) {
        String line = lines.get(i).trim();

        // è·³è¿‡æ³¨é‡Š
        if (line.startsWith("//") || line.startsWith("/*")) continue;

        // æ£€æµ‹å‡½æ•°ç­¾å
        if (FUNCTION_PATTERN.matcher(line).matches()) {
            return i;
        }

        // æ£€æµ‹å¤šè¡Œç­¾åçš„ç»“æŸï¼ˆå·¦æ‹¬å·ï¼‰
        if (line.endsWith("{") && i > 0) {
            // å‘ä¸ŠæŸ¥æ‰¾ç­¾åå¼€å§‹
            for (int j = i - 1; j >= Math.max(0, i - 5); j--) {
                if (lines.get(j).matches("^[a-zA-Z_].*")) {
                    return j;
                }
            }
        }
    }
    return Math.max(0, issueLineIndex - 10); // å›é€€
}
```

**æµ‹è¯•å»ºè®®ï¼š**
åˆ›å»ºå•å…ƒæµ‹è¯•è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š
1. ç®€å•å‡½æ•° `int foo() { ... }`
2. å¤šè¡Œç­¾åå‡½æ•°
3. é™æ€/å†…è”å‡½æ•°
4. åµŒå¥—èŠ±æ‹¬å·ï¼ˆif/for/whileï¼‰
5. è¾¹ç•Œæƒ…å†µï¼ˆæ–‡ä»¶å¼€å¤´/ç»“å°¾ï¼‰

### T3.4: PromptBuilder.java

**å¯è¡Œæ€§ï¼š** âœ… é«˜åº¦å¯è¡Œ

**æç¤ºè¯å·¥ç¨‹è¯„ä¼°ï¼š**

**Issue Validation Promptåˆ†æï¼š**

âœ… **ä¼˜ç‚¹ï¼š**
1. æ˜ç¡®çš„è§’è‰²å®šä¹‰ï¼ˆ"C/C++ static analysis expert"ï¼‰
2. ç»“æ„åŒ–è¾“å…¥ï¼ˆé—®é¢˜å…ƒæ•°æ® + ä»£ç ä¸Šä¸‹æ–‡ï¼‰
3. å¼ºåˆ¶JSONè¾“å‡ºï¼ˆä¾¿äºè§£æï¼‰
4. å…·ä½“çš„è¯„ä¼°ç»´åº¦ï¼ˆbuffer sizes, bounds checks...ï¼‰

âš ï¸ **æ”¹è¿›ç‚¹ï¼š**
1. **æ·»åŠ Few-Shotç¤ºä¾‹**
   ```java
   """
   Example 1 (Real Vulnerability):
   {
     "is_vulnerability": true,
     "reason": "Buffer overflow: strcpy without bounds check on user input",
     "suggested_severity": "Critical"
   }

   Example 2 (False Positive):
   {
     "is_vulnerability": false,
     "reason": "Input is validated and size-limited before strcpy call",
     "suggested_severity": "Info"
   }

   Now analyze this case:
   ...
   """
   ```

2. **å¢å¼ºä¸Šä¸‹æ–‡**
   ```java
   // æ·»åŠ è°ƒç”¨è€…ä¿¡æ¯
   - Callers: %s
   - Function signature: %s
   ```

3. **ä¸¥é‡ç¨‹åº¦æ˜ å°„**
   ```java
   // ç¡®ä¿ä¸IssueSeverityæšä¸¾ä¸€è‡´
   - Critical: Memory corruption, RCE potential
   - High: Privilege escalation, data leak
   - Medium: DoS, logic errors
   - Low: Code quality issues
   ```

**Rust FFI Promptåˆ†æï¼š**

âœ… **ä¼˜ç‚¹ï¼š**
1. æ¸…æ™°çš„4ä¸ªåˆ†æç»´åº¦
2. å®ç”¨çš„è¿ç§»æŒ‡å¯¼
3. Markdownæ ¼å¼åŒ–è¾“å‡º

âš ï¸ **æ”¹è¿›ç‚¹ï¼š**
1. **æ·»åŠ çº¦æŸ**
   ```java
   """
   Constraints:
   - FFI wrapper must be `#[no_mangle]` and `extern "C"`
   - Use `std::ffi::CStr` for C strings
   - All raw pointers must be checked for null
   - Example output length: 200-500 lines
   """
   ```

2. **æ€§èƒ½è€ƒè™‘**
   ```java
   """
   5. **Performance Considerations**:
      - FFI call overhead
      - Zero-copy strategies
      - Allocation patterns
   """
   ```

### T3.5: DecisionEngine.java

**å¯è¡Œæ€§ï¼š** âœ… é«˜åº¦å¯è¡Œ

**æ¶æ„åˆ†æï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AnalysisEngine                  â”‚
â”‚  (åè°ƒé™æ€åˆ†æå™¨)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ List<SecurityIssue> (é™æ€åˆ†æç»“æœ)
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DecisionEngine                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ needsAiValidation(issue)        â”‚   â”‚ â† ç­–ç•¥å¼•æ“
â”‚  â”‚  - Semgrep issues: YES          â”‚   â”‚
â”‚  â”‚  - Regex issues: YES            â”‚   â”‚
â”‚  â”‚  - Clang-Tidy: NO (é«˜ç½®ä¿¡åº¦)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                          â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CodeSlicer.getContextSlice()    â”‚   â”‚ â† T3.3
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                          â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ PromptBuilder.build*Prompt()    â”‚   â”‚ â† T3.4
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                          â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CachedLlmClient.sendRequest()   â”‚   â”‚ â† T3.1 + T3.2
â”‚  â”‚   â”œâ”€ Cache Hit? â†’ Return        â”‚   â”‚
â”‚  â”‚   â””â”€ Cache Miss â†’ LlmClient     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                          â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Gson.fromJson(response)         â”‚   â”‚
â”‚  â”‚ â†’ AiValidationResponse          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                          â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ if (is_vulnerability) {         â”‚   â”‚
â”‚  â”‚   issue.setAiExplanation()      â”‚   â”‚
â”‚  â”‚   issue.setSeverity()           â”‚   â”‚
â”‚  â”‚   issue.setConfidence(0.95)     â”‚   â”‚
â”‚  â”‚   add to result                 â”‚   â”‚
â”‚  â”‚ } else {                        â”‚   â”‚
â”‚  â”‚   filter out (false positive)   â”‚   â”‚
â”‚  â”‚ }                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        List<SecurityIssue> (AIå¢å¼ºç»“æœ)
```

**å…³é”®è®¾è®¡å†³ç­–ï¼š**

1. **è¿‡æ»¤ç­–ç•¥**
   ```java
   private boolean needsAiValidation(SecurityIssue issue) {
       String source = issue.getSource().toLowerCase();

       // Semgrep: è¯¯æŠ¥ç‡é«˜ (20-40%)
       if (source.equals("semgrep")) return true;

       // Regex: è¯¯æŠ¥ç‡æé«˜ (50-70%)
       if (source.contains("regex")) return true;

       // Clang-Tidy: è¯¯æŠ¥ç‡ä½ (5-10%)ï¼Œä½†æˆæœ¬é«˜
       // ç­–ç•¥ï¼šä»…å¯¹Criticalçº§åˆ«éªŒè¯
       if (source.equals("clang-tidy") &&
           issue.getSeverity() == IssueSeverity.CRITICAL) {
           return true;
       }

       return false;
   }
   ```

2. **ç½®ä¿¡åº¦æ¨¡å‹**
   ```java
   // é™æ€åˆ†æå™¨åŸºçº¿ç½®ä¿¡åº¦
   Map<String, Double> baselineConfidence = Map.of(
       "clang-tidy", 0.90,
       "semgrep", 0.60,
       "regex", 0.40
   );

   // AIéªŒè¯åç½®ä¿¡åº¦
   if (validation.is_vulnerability) {
       issue.setConfidence(0.95); // AIç¡®è®¤
   } else {
       // ä¸æ·»åŠ åˆ°ç»“æœï¼ˆè¿‡æ»¤æ‰ï¼‰
   }
   ```

3. **å¼‚å¸¸é™çº§**
   ```java
   try {
       // AIå¢å¼º
   } catch (Exception e) {
       logger.error("AI validation failed for issue: {}", issue.getId(), e);

       // é™çº§ç­–ç•¥ï¼šä¿ç•™åŸå§‹é—®é¢˜ï¼Œä½†é™ä½ç½®ä¿¡åº¦
       issue.setConfidence(baselineConfidence.get(issue.getSource()) * 0.8);
       enhancedIssues.add(issue);
   }
   ```

**æ€§èƒ½è€ƒè™‘ï¼š**

| åœºæ™¯ | é™æ€åˆ†æè€—æ—¶ | AIéªŒè¯è€—æ—¶ | æ€»è€—æ—¶ | åŠ é€Ÿç­–ç•¥ |
|------|--------------|------------|--------|----------|
| 100æ–‡ä»¶, 50issues | 25s (å¹¶è¡Œ) | 50s (ä¸²è¡Œ) | 75s | âŒ ç“¶é¢ˆåœ¨AI |
| 100æ–‡ä»¶, 50issues | 25s (å¹¶è¡Œ) | 10s (30%ç¼“å­˜) | 35s | âœ… ç¼“å­˜æœ‰æ•ˆ |
| 100æ–‡ä»¶, 50issues | 25s (å¹¶è¡Œ) | 5s (AIå¹¶è¡Œ) | 30s | âœ… å¹¶è¡ŒAIè°ƒç”¨ |

**æ¨èä¼˜åŒ–ï¼šå¹¶è¡ŒAIéªŒè¯**
```java
public List<SecurityIssue> enhanceIssues(List<SecurityIssue> staticIssues) {
    List<SecurityIssue> needValidation = staticIssues.stream()
        .filter(this::needsAiValidation)
        .collect(Collectors.toList());

    List<SecurityIssue> noValidation = staticIssues.stream()
        .filter(issue -> !needsAiValidation(issue))
        .peek(issue -> issue.setConfidence(0.90))
        .collect(Collectors.toList());

    // å¹¶è¡Œå¤„ç†éœ€è¦éªŒè¯çš„é—®é¢˜
    List<SecurityIssue> validated = needValidation.parallelStream()
        .map(this::validateWithAi)  // è¿”å›Optional<SecurityIssue>
        .filter(Optional::isPresent)
        .map(Optional::get)
        .collect(Collectors.toList());

    List<SecurityIssue> result = new ArrayList<>();
    result.addAll(noValidation);
    result.addAll(validated);
    return result;
}

private Optional<SecurityIssue> validateWithAi(SecurityIssue issue) {
    try {
        // AIéªŒè¯é€»è¾‘
        // ...
        if (validation.is_vulnerability) {
            return Optional.of(enhancedIssue);
        } else {
            return Optional.empty(); // è¿‡æ»¤æ‰
        }
    } catch (Exception e) {
        logger.error("AI validation failed", e);
        return Optional.of(issue); // é™çº§ä¿ç•™
    }
}
```

---

## ğŸ’¡ é›†æˆç­–ç•¥å»ºè®®

### å®æ–½é¡ºåº

```
Phase 3.1: åŸºç¡€è®¾æ–½ (2-3å¤©)
â”œâ”€ T3.1: LlmClient (1å¤©)
â”‚  â”œâ”€ å®ç°åŸºç¡€HTTPå®¢æˆ·ç«¯
â”‚  â”œâ”€ æ·»åŠ é‡è¯•é€»è¾‘
â”‚  â””â”€ å•å…ƒæµ‹è¯• (mock API)
â”‚
â”œâ”€ T3.2: CachedLlmClient (0.5å¤©)
â”‚  â”œâ”€ æ·»åŠ Guavaä¾èµ–
â”‚  â”œâ”€ å®ç°è£…é¥°å™¨
â”‚  â””â”€ ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•
â”‚
â””â”€ T3.4: PromptBuilder (0.5å¤©)
   â”œâ”€ å®ç°ä¸¤ä¸ªæç¤ºè¯æ„å»ºå™¨
   â””â”€ æç¤ºè¯è´¨é‡æµ‹è¯• (æ‰‹åŠ¨éªŒè¯)

Phase 3.2: æ ¸å¿ƒé€»è¾‘ (2-3å¤©)
â”œâ”€ T3.3: CodeSlicer (1.5å¤©)
â”‚  â”œâ”€ å®ç°åŸºç¡€åˆ‡ç‰‡é€»è¾‘
â”‚  â”œâ”€ å¤„ç†è¾¹ç•Œæƒ…å†µ
â”‚  â””â”€ å•å…ƒæµ‹è¯• (å‡†å¤‡æµ‹è¯•ç”¨Cæ–‡ä»¶)
â”‚
â””â”€ T3.5: DecisionEngine (1.5å¤©)
   â”œâ”€ å®ç°ç¼–æ’é€»è¾‘
   â”œâ”€ é›†æˆåˆ°AnalysisEngine
   â””â”€ ç«¯åˆ°ç«¯æµ‹è¯•

Phase 3.3: æµ‹è¯•ä¸ä¼˜åŒ– (1-2å¤©)
â”œâ”€ é›†æˆæµ‹è¯•
â”œâ”€ æ€§èƒ½è°ƒä¼˜
â””â”€ æ–‡æ¡£ç¼–å†™
```

### é£é™©ç¼“è§£æ¸…å•

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ | è´£ä»»äºº |
|------|------|------|----------|--------|
| LLM APIä¸ç¨³å®š | ä¸­ | é«˜ | å®ç°é‡è¯•+é™çº§+ç¼“å­˜ | T3.1 |
| CodeSlicerè¯¯åˆ‡ç‰‡ | é«˜ | ä¸­ | æ‰©å¤§ä¸Šä¸‹æ–‡èŒƒå›´+å›é€€æœºåˆ¶ | T3.3 |
| AIå“åº”æ ¼å¼é”™è¯¯ | ä¸­ | ä¸­ | JSON SchemaéªŒè¯+å¼‚å¸¸å¤„ç† | T3.5 |
| æˆæœ¬è¶…é¢„ç®— | ä½ | ä¸­ | ç¼“å­˜+è¯·æ±‚è®¡æ•°+é˜ˆå€¼å‘Šè­¦ | T3.2 |
| å†…å­˜æ³„æ¼ | ä½ | é«˜ | Guavaç¼“å­˜é…ç½®+ç›‘æ§ | T3.2 |

### æµ‹è¯•ç­–ç•¥

**å•å…ƒæµ‹è¯•è¦†ç›–ç‡ç›®æ ‡ï¼š80%+**

```
T3.1 LlmClient:
âœ“ æ­£å¸¸è¯·æ±‚å“åº”
âœ“ è¶…æ—¶å¤„ç†
âœ“ é‡è¯•é€»è¾‘
âœ“ JSONè§£æé”™è¯¯
âœ“ ç½‘ç»œé”™è¯¯

T3.2 CachedLlmClient:
âœ“ ç¼“å­˜å‘½ä¸­
âœ“ ç¼“å­˜æœªå‘½ä¸­
âœ“ ç¼“å­˜è¿‡æœŸ
âœ“ å¹¶å‘è®¿é—®

T3.3 CodeSlicer:
âœ“ ç®€å•å‡½æ•°åˆ‡ç‰‡
âœ“ åµŒå¥—ç»“æ„
âœ“ å¤šè¡Œç­¾å
âœ“ è¾¹ç•Œæƒ…å†µï¼ˆæ–‡ä»¶é¦–å°¾ï¼‰
âœ“ é”™è¯¯å¤„ç†ï¼ˆæ— æ•ˆè¡Œå·ï¼‰

T3.4 PromptBuilder:
âœ“ æç¤ºè¯æ ¼å¼
âœ“ ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
âœ“ å˜é‡æ›¿æ¢

T3.5 DecisionEngine:
âœ“ è¿‡æ»¤ç­–ç•¥
âœ“ AIéªŒè¯æˆåŠŸ
âœ“ AIéªŒè¯å¤±è´¥ï¼ˆé™çº§ï¼‰
âœ“ å¹¶å‘å¤„ç†
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### å®šé‡æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ï¼ˆä»…é™æ€ï¼‰ | é˜¶æ®µ3å | æ”¹è¿› |
|------|---------------|---------|------|
| è¯¯æŠ¥ç‡ | 30-40% | 10-15% | â†“60% |
| æ¼æŠ¥ç‡ | 5-10% | 5-10% | â†” |
| åˆ†æè€—æ—¶ | 25s/100æ–‡ä»¶ | 35-50s/100æ–‡ä»¶ | â†‘40-100% |
| äººå·¥å®¡æ ¸æ—¶é—´ | 2å°æ—¶/100é—®é¢˜ | 0.5å°æ—¶/30é—®é¢˜ | â†“75% |

### å®šæ€§æ”¹è¿›

1. **æ›´é«˜çš„ç½®ä¿¡åº¦**
   - AIéªŒè¯åçš„é—®é¢˜å¯ç›´æ¥ä¿®å¤ï¼Œæ— éœ€äººå·¥ç¡®è®¤
   - å‡å°‘å®‰å…¨å›¢é˜Ÿçš„å®¡æ ¸è´Ÿæ‹…

2. **æ›´å¥½çš„å¼€å‘è€…ä½“éªŒ**
   - AIè§£é‡Šè®©é—®é¢˜æ›´æ˜“ç†è§£
   - Rustè¿ç§»å»ºè®®æä¾›å¯æ“ä½œçš„è·¯å¾„

3. **æ›´æ™ºèƒ½çš„ä¼˜å…ˆçº§**
   - åŸºäºAIéªŒè¯çš„ä¸¥é‡ç¨‹åº¦æ›´å‡†ç¡®
   - å‡å°‘ä½ä¼˜å…ˆçº§è¯¯æŠ¥çš„å¹²æ‰°

---

## âœ… æœ€ç»ˆç»“è®º

### T2.4-Refactor
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆå¹¶é€šè¿‡éªŒè¯

**å®ç°è´¨é‡ï¼š** ä¼˜äºéœ€æ±‚è§„æ ¼
- æ·»åŠ äº†é¡ºåºæ‰§è¡Œå›é€€
- æ›´å¥å£®çš„å¼‚å¸¸å¤„ç†
- ç¼–è¯‘é€šè¿‡ï¼Œæ— è¯­æ³•é”™è¯¯

### é˜¶æ®µ3 - AIå¢å¼º
**æ€»ä½“å¯è¡Œæ€§ï¼š** âœ… é«˜åº¦å¯è¡Œ

**æ¨èå®æ–½ï¼š** æ˜¯

**å…³é”®æˆåŠŸå› ç´ ï¼š**
1. âœ… æŠ€æœ¯æ ˆæˆç†Ÿï¼ˆOkHttp, Gson, Guavaï¼‰
2. âœ… è®¾è®¡æ¸…æ™°ï¼ˆå•ä¸€èŒè´£ï¼Œè£…é¥°å™¨æ¨¡å¼ï¼‰
3. âœ… é£é™©å¯æ§ï¼ˆç¼“å­˜ã€é‡è¯•ã€é™çº§ï¼‰
4. âš ï¸ éœ€è¦æŠ•å…¥ç²¾åŠ›åœ¨CodeSlicerçš„æµ‹è¯•ä¸Š
5. âš ï¸ éœ€è¦ç›‘æ§LLM APIæˆæœ¬

**é¢„ä¼°æŠ•å…¥ï¼š**
- å¼€å‘æ—¶é—´ï¼š5-8å¤©
- æµ‹è¯•æ—¶é—´ï¼š2-3å¤©
- æ€»è®¡ï¼š**1-2å‘¨**

**ROIåˆ†æï¼š**
- æˆæœ¬ï¼šå¼€å‘1-2å‘¨ + APIè´¹ç”¨$0.05/100é—®é¢˜
- æ”¶ç›Šï¼šäººå·¥å®¡æ ¸æ—¶é—´å‡å°‘75%ï¼Œè¯¯æŠ¥ç‡é™ä½60%
- **é¢„æœŸROIï¼š** 300-500%ï¼ˆåŸºäºå›¢é˜Ÿè§„æ¨¡ï¼‰

---

## ğŸ¯ å»ºè®®çš„ä¸‹ä¸€æ­¥

1. **ç«‹å³æ‰§è¡Œï¼š** ç¡®è®¤T2.4ç¼–è¯‘é€šè¿‡å¹¶æäº¤
2. **å‡†å¤‡ç¯å¢ƒï¼š** è·å–LLM APIå¯†é’¥ï¼Œé…ç½®æµ‹è¯•ç¯å¢ƒ
3. **å¼€å§‹T3.1ï¼š** å®ç°LlmClientåŸºç¡€è®¾æ–½
4. **å¹¶è¡Œå‡†å¤‡ï¼š** åˆ›å»ºCodeSlicerçš„æµ‹è¯•ç”¨Cæ–‡ä»¶é›†

**å¯ä»¥å¼€å§‹äº†å—ï¼Ÿ** ğŸš€
