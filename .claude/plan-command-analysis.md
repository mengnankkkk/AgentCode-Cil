# /plan å‘½ä»¤å®Œæ•´å®ç°åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-10-29
**åˆ†ææ·±åº¦**: Medium
**åˆ†æç±»å‹**: åŠŸèƒ½æµç¨‹åˆ†æ + ç¼ºå¤±éƒ¨åˆ†è¯†åˆ«

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

### æ•´ä½“çŠ¶å†µ
âœ… `/plan` å‘½ä»¤å·²å…¨é¢å®ç°ï¼Œå®Œæ•´çš„æ¶æ„åŒ…æ‹¬ï¼š
- éœ€æ±‚åˆ†æï¼ˆAnalyzerRoleï¼‰â†’ ä»»åŠ¡åˆ†è§£
- ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼ˆTodoListManagerï¼‰â†’ è‡ªåŠ¨è§’è‰²è·¯ç”±ï¼ˆ/nextï¼‰
- å››å±‚è§’è‰²ç³»ç»Ÿï¼ˆAnalyzerã€Plannerã€Coderã€Reviewerï¼‰
- é…ç½®é©±åŠ¨çš„æ¨¡å‹å’Œæä¾›å•†é€‰æ‹©

### å…³é”®å‘ç°
ğŸš¨ **æ£€æµ‹åˆ°çš„é—®é¢˜**ï¼š
1. **é›¶æµ‹è¯•è¦†ç›–** - æ²¡æœ‰ä¸“é—¨çš„å•å…ƒæµ‹è¯•æˆ–é›†æˆæµ‹è¯•è¦†ç›–è§’è‰²å’Œå‘½ä»¤
2. **è§’è‰²åˆ†è§£é€»è¾‘ä¸å¤Ÿæ™ºèƒ½** - ä»»åŠ¡åˆ°è§’è‰²çš„æ˜ å°„åŸºäºç®€å•çš„å…³é”®å­—åŒ¹é…
3. **ç¼ºå¤±ä¸Šä¸‹æ–‡é“¾æ¥** - ä»»åŠ¡æ‰§è¡Œé—´çš„ä¸Šä¸‹æ–‡ç®¡ç†åŸºç¡€ä½†å¯æ”¹è¿›
4. **æ²¡æœ‰å¤±è´¥æ¢å¤æœºåˆ¶** - ä»»åŠ¡å¤±è´¥æ—¶ç¼ºä¹é‡è¯•ç­–ç•¥

---

## äºŒã€/plan å‘½ä»¤å®Œæ•´å®ç°æµç¨‹

### 2.1 æ ¸å¿ƒæ‰§è¡Œé“¾è·¯

**å…¥å£**: InteractiveCommand.handlePlanCommand (ç¬¬578-595è¡Œ)
- éªŒè¯å‚æ•°å’Œç°æœ‰ä»»åŠ¡
- è°ƒç”¨ TodoListManager.createTodoList

**ä»»åŠ¡åˆ†è§£**: TodoListManager.createTodoList (ç¬¬29-78è¡Œ)
- æ£€æŸ¥LLMå¯ç”¨æ€§
- è°ƒç”¨ LLMClient.breakdownRequirement

**éœ€æ±‚åˆ†æ**: LLMClient.breakdownRequirement (ç¬¬254-279è¡Œ)
- å¦‚æœæœ‰APIå¯†é’¥: è°ƒç”¨ LLMOrchestrator.analyzeRequirement
- å¦åˆ™: ä½¿ç”¨è§„åˆ™åŸºç¡€çš„ breakdownRequirementFallback

**æ ¸å¿ƒç¼–æ’**: LLMOrchestrator.analyzeRequirement (ç¬¬118-135è¡Œ)
- ä½¿ç”¨ AnalyzerRole æ‰§è¡Œéœ€æ±‚åˆ†æ
- è°ƒç”¨é…ç½®çš„AIæä¾›å•†
- è§£æå“åº”ä¸ºä»»åŠ¡åˆ—è¡¨
- åˆ›å»º TodoList å¯¹è±¡

**AnalyzerRole å®ç°**: AnalyzerRole.java
- ç³»ç»Ÿæç¤º: å°†éœ€æ±‚åˆ†è§£ä¸º3-7ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡
- æ¸©åº¦: 0.3 (ä½åˆ›é€ æ€§ï¼Œä¸€è‡´æ€§é«˜)
- Max tokens: 1000

### 2.2 /next å‘½ä»¤æ‰§è¡Œæµç¨‹

**ä»»åŠ¡æ‰§è¡Œé“¾è·¯**:

ç”¨æˆ·è¾“å…¥: /next
  â†“
[InteractiveCommand.handleExecuteCommand]
  â†“
[TodoListManager.executeCurrentTask]
  â†“
[LLMClient.executeTask]
  â†“
[determineRoleForTask] â† å…³é”®åˆ†æ”¯ç‚¹
  â”œâ†’ "design/architect/plan/strategy" â†’ PlannerRole
  â”œâ†’ "implement/code/write/create/develop" â†’ CoderRole
  â”œâ†’ "review/verify/check/validate" â†’ ReviewerRole
  â”œâ†’ "analyze/identify/find/detect" â†’ AnalyzerRole
  â””â†’ (é»˜è®¤: PlannerRole)
  â†“
[LLMOrchestrator.executeRole]
  â†“
[è§’è‰²æ‰§è¡Œ] â†’ è°ƒç”¨é…ç½®çš„æä¾›å•†å’Œæ¨¡å‹
  â†“
è¿”å›ç»“æœå¹¶æ ‡è®°ä»»åŠ¡å®Œæˆ
  â†“
è‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªä»»åŠ¡

### 2.3 è§’è‰²é…ç½®çŸ©é˜µ

| è§’è‰² | æä¾›å•† | æ¨¡å‹ | æ¸©åº¦ | Max Tokens | ç”¨é€” |
|------|--------|------|------|------------|------|
| Analyzer | nhh | fast (glm-4.5-flash) | 0.3 | 1000 | åˆ†æéœ€æ±‚ã€è¯†åˆ«é—®é¢˜ |
| Planner | nhh | standard (glm-4.5) | 0.5 | 2500 | è®¾è®¡æ–¹æ¡ˆã€åˆ¶å®šç­–ç•¥ |
| Coder | nhh | coder (qwen-coder) | 0.2 | 3000 | ä»£ç å®ç°ã€å¼€å‘ |
| Reviewer | nhh | standard (glm-4.5) | 0.7 | 2500 | ä»£ç å®¡æŸ¥ã€è´¨é‡éªŒè¯ |

*æ³¨: application.yml ä¸­çš„é…ç½® (ç¬¬65-96è¡Œ)*

---

## ä¸‰ã€å‘ç°çš„é—®é¢˜

### ğŸš¨ **é—®é¢˜1: é›¶æµ‹è¯•è¦†ç›–**

**ç°çŠ¶**: æ²¡æœ‰ä¸ºä»»ä½•è§’è‰²æˆ–å‘½ä»¤ç¼–å†™æµ‹è¯•
- âœ… å·²æœ‰æµ‹è¯•: ReportGeneratorTest, CompileCommandsParserTest, DecisionEngineFilterTest, E2E Tests
- âŒ ç¼ºå¤±æµ‹è¯•: AnalyzerRole, PlannerRole, CoderRole, ReviewerRole, TodoListManager, /plan å’Œ /next å‘½ä»¤

**å½±å“**: 
- æ— æ³•éªŒè¯è§’è‰²çš„ç³»ç»Ÿæç¤ºæ˜¯å¦æœ‰æ•ˆ
- æ— æ³•æµ‹è¯•ä»»åŠ¡åˆ°è§’è‰²çš„è·¯ç”±é€»è¾‘
- æ— æ³•éªŒè¯åº”å¯¹APIå¤±è´¥çš„å›é€€æœºåˆ¶

**å»ºè®®ä¿®å¤**: åˆ›å»ºä»¥ä¸‹æµ‹è¯•å¥—ä»¶
- src/test/java/com/harmony/agent/llm/role/{AnalyzerRoleTest, PlannerRoleTest, CoderRoleTest, ReviewerRoleTest}
- src/test/java/com/harmony/agent/task/TodoListManagerTest
- src/test/java/com/harmony/agent/llm/orchestrator/LLMOrchestratorIntegrationTest
- src/test/java/com/harmony/agent/cli/InteractiveCommandPlanTest

### ğŸŸ¡ **é—®é¢˜2: ä»»åŠ¡åˆ°è§’è‰²çš„è·¯ç”±è¿‡äºç®€å•**

**ç°çŠ¶**: LLMClient.determineRoleForTask (ç¬¬399-429è¡Œ) ä½¿ç”¨ç®€å•çš„å…³é”®å­—åŒ¹é…

```java
private String determineRoleForTask(String taskDescription) {
    String lower = taskDescription.toLowerCase();
    if (lower.contains("design") || lower.contains("architect")) {
        return "planner";
    }
    // ... æ›´å¤šå…³é”®å­—æ£€æŸ¥
    return "planner";  // é»˜è®¤
}
```

**é—®é¢˜**:
- ä¸æ”¯æŒå¤šè¯­è¨€ï¼ˆåº”ç”¨æ”¯æŒä¸­æ–‡ï¼Œä½†é€»è¾‘ä»…è‹±æ–‡ï¼‰
- ä¸èƒ½å¤„ç†å¤æ‚çš„æ··åˆä»»åŠ¡ï¼ˆå¦‚"è®¾è®¡å¹¶å®ç°")
- æ²¡æœ‰è€ƒè™‘ä»»åŠ¡çš„å‰ç½®ä¾èµ–æˆ–ä¸Šä¸‹æ–‡

**å»ºè®®æ”¹è¿›**:
1. ä½¿ç”¨LLMè‡ªèº«å†³å®šæœ€ä½³è§’è‰²ï¼ˆå…ƒè·¯ç”±ï¼‰
2. æ”¯æŒå¤åˆä»»åŠ¡çš„å¤šæ­¥æ‰§è¡Œ
3. è€ƒè™‘ä»»åŠ¡é—´çš„ä¾èµ–å…³ç³»

### ğŸŸ¡ **é—®é¢˜3: ç¼ºå¤±ä¸Šä¸‹æ–‡é“¾æ¥**

**ç°çŠ¶**: TodoListManager.buildContext (ç¬¬187-201è¡Œ) ä»…æ‹¼æ¥å®Œæˆçš„ä»»åŠ¡

```java
private String buildContext() {
    StringBuilder context = new StringBuilder();
    context.append("Requirement: ").append(activeTodoList.getRequirement()).append("

");
    context.append("Completed tasks:
");
    for (Task task : activeTodoList.getCompletedTasks()) {
        context.append(String.format("- %s: %s
", task.getDescription(), task.getOutput()));
    }
    return context.toString();  // çº¯æ–‡æœ¬æ‹¼æ¥
}
```

**é—®é¢˜**:
- ä¸Šä¸‹æ–‡åªåŒ…å«å®Œæˆçš„ä»»åŠ¡ï¼Œä¸åŒ…å«å³å°†æ‰§è¡Œçš„ä»»åŠ¡
- æ²¡æœ‰ä»»åŠ¡é—´çš„é€»è¾‘é“¾æ¥ä¿¡æ¯
- ä¸æ”¯æŒè·¨ä¼šè¯çš„ä¸Šä¸‹æ–‡æŒä¹…åŒ–

**å»ºè®®æ”¹è¿›**:
1. ä½¿ç”¨ç»“æ„åŒ–çš„ConversationContextè€Œéçº¯æ–‡æœ¬
2. æ·»åŠ "ä¸‹ä¸€ä¸ªä»»åŠ¡æ¦‚è§ˆ"åˆ°ä¸Šä¸‹æ–‡ä¸­
3. å®ç°ä¼šè¯ä¿å­˜å’Œæ¢å¤

### ğŸ”´ **é—®é¢˜4: ç¼ºå¤±å¤±è´¥æ¢å¤æœºåˆ¶**

**ç°çŠ¶**: LLMClient.executeTask (ç¬¬333-362è¡Œ) æ²¡æœ‰é‡è¯•æœºåˆ¶

```java
public String executeTask(String taskDescription, String context) {
    try {
        LLMResponse response = orchestrator.executeRole(roleName, taskDescription, ctx);
        if (response.isSuccess()) {
            return response.getContent();
        } else {
            return executeFallback(taskDescription);  // ç›´æ¥é™çº§
        }
    } catch (Exception e) {
        return executeFallback(taskDescription);  // å¼‚å¸¸ç›´æ¥é™çº§
    }
}
```

**é—®é¢˜**:
- æ²¡æœ‰é‡è¯•æœºåˆ¶ï¼ˆå¯¹äºä¸´æ—¶APIé”™è¯¯ï¼‰
- æ²¡æœ‰éƒ¨åˆ†æˆåŠŸçš„å¤„ç†
- æ²¡æœ‰é”™è¯¯åˆ†ç±»ï¼ˆä¸´æ—¶vsæ°¸ä¹…ï¼‰

**å»ºè®®æ”¹è¿›**:
1. å®ç°æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
2. æ ¹æ®é”™è¯¯ç±»å‹é€‰æ‹©ç­–ç•¥
3. æ·»åŠ ä»»åŠ¡å¤±è´¥çš„ç”¨æˆ·äº¤äº’

### ğŸŸ¡ **é—®é¢˜5: é…ç½®å®‰å…¨æ€§**

**ç°çŠ¶**: application.yml ä¸­æœ‰ç¡¬ç¼–ç çš„APIå¯†é’¥

**å»ºè®®æ”¹è¿›**:
1. å°†APIå¯†é’¥ç§»è‡³ç¯å¢ƒå˜é‡ï¼ˆå·²æ”¯æŒï¼Œä½†æ–‡ä»¶ä¸­ç¡¬ç¼–ç ï¼‰
2. åœ¨åˆå§‹åŒ–æ—¶éªŒè¯é…ç½®çš„å®Œæ•´æ€§
3. æ”¯æŒé…ç½®çƒ­é‡è½½

---

## å››ã€å®Œæ•´æ€§æ£€æŸ¥æ¸…å•

### âœ… å·²å®Œæˆ
- [x] AnalyzerRole å®ç°
- [x] PlannerRole å®ç°
- [x] CoderRole å®ç°
- [x] ReviewerRole å®ç°
- [x] TodoListManager å®ç°
- [x] ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
- [x] LLMOrchestrator ç¼–æ’
- [x] å¤šæä¾›å•†æ”¯æŒ
- [x] é…ç½®é©±åŠ¨çš„è§’è‰²é€‰æ‹©
- [x] å›é€€æ¨¡å¼ï¼ˆæ— APIå¯†é’¥æ—¶ï¼‰
- [x] /plan å‘½ä»¤
- [x] /next å‘½ä»¤
- [x] ä»»åŠ¡æ˜¾ç¤ºå‘½ä»¤ (/tasks, /current)

### âš ï¸ éœ€è¦æ”¹è¿›
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] é›†æˆæµ‹è¯•è¦†ç›–
- [ ] é‡è¯•æœºåˆ¶
- [ ] ä¸­æ–‡ä»»åŠ¡è·¯ç”±
- [ ] ä¸Šä¸‹æ–‡æŒä¹…åŒ–
- [ ] é…ç½®éªŒè¯

### âŒ å®Œå…¨ç¼ºå¤±
- [ ] ä»»åŠ¡ä¾èµ–ç®¡ç†
- [ ] ä»»åŠ¡ä¼˜å…ˆçº§
- [ ] å¹¶å‘ä»»åŠ¡æ‰§è¡Œ
- [ ] ç”¨æˆ·äº¤äº’å¼é”™è¯¯æ¢å¤
- [ ] ä»»åŠ¡å®¡æ‰¹æµç¨‹

---

## äº”ã€å…³é”®æ–‡ä»¶ä½ç½®æ±‡æ€»

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ | è¡Œå· |
|------|---------|------|
| /plan å‘½ä»¤å…¥å£ | InteractiveCommand.java | 362-364 |
| /plan å‘½ä»¤å®ç° | InteractiveCommand.java | 578-595 |
| /next å‘½ä»¤å…¥å£ | InteractiveCommand.java | 366-369 |
| /next å‘½ä»¤å®ç° | InteractiveCommand.java | 600-607 |
| ä»»åŠ¡ç®¡ç† | TodoListManager.java | 1-216 |
| éœ€æ±‚åˆ†è§£ | LLMClient.java | 254-279 |
| ä»»åŠ¡æ‰§è¡Œ | LLMClient.java | 333-362 |
| è§’è‰²è·¯ç”± | LLMClient.java | 399-429 |
| ç¼–æ’å™¨ | LLMOrchestrator.java | 1-150+ |
| Analyzer è§’è‰² | AnalyzerRole.java | 1-50 |
| Planner è§’è‰² | PlannerRole.java | 1-51 |
| Coder è§’è‰² | CoderRole.java | 1-52 |
| Reviewer è§’è‰² | ReviewerRole.java | 1-58 |
| é…ç½®æ–‡ä»¶ | application.yml | 1-152 |
| è§’è‰²å·¥å‚ | RoleFactory.java | 1-52 |

---

## å…­ã€æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ (å½±å“åŠŸèƒ½å®Œæ•´æ€§)
1. æ·»åŠ å•å…ƒæµ‹è¯• - æ— æµ‹è¯•è¦†ç›–æ„å‘³ç€æ— æ³•éªŒè¯åŠŸèƒ½
2. å®ç°é‡è¯•æœºåˆ¶ - APIå¤±è´¥æ—¶æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
3. æ”¹è¿›é”™è¯¯å¤„ç† - ç›®å‰çš„é™çº§è¿‡äºç²—ç³™

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ (å½±å“ç”¨æˆ·ä½“éªŒ)
1. æ”¹è¿›è§’è‰²è·¯ç”± - æ”¯æŒæ›´å¤æ‚çš„ä»»åŠ¡åˆ†ç±»
2. ä¸Šä¸‹æ–‡æŒä¹…åŒ– - æ”¯æŒä¼šè¯æ¢å¤
3. é…ç½®éªŒè¯ - æå‰å‘ç°é…ç½®é—®é¢˜

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ (æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§)
1. ä¸­æ–‡æ”¯æŒ - ä»»åŠ¡è·¯ç”±é€»è¾‘
2. ä»»åŠ¡ä¾èµ– - å‰ç½®æ¡ä»¶æ£€æŸ¥
3. æ€§èƒ½ä¼˜åŒ– - ç¼“å­˜å’Œå¹¶è¡ŒåŒ–

---

## ä¸ƒã€æ€»ä½“è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | å¤‡æ³¨ |
|------|------|------|
| åŠŸèƒ½å®Œæ•´æ€§ | 85/100 | æ ¸å¿ƒæµç¨‹å®Œæ•´ï¼Œç¼ºä¹é«˜çº§ç‰¹æ€§ |
| ä»£ç è´¨é‡ | 75/100 | ç»“æ„æ¸…æ™°ï¼Œç¼ºä¹æµ‹è¯•è¦†ç›– |
| å¯é…ç½®æ€§ | 90/100 | æ”¯æŒå¤šæä¾›å•†å’Œæ¨¡å‹ï¼Œé…ç½®çµæ´» |
| é”™è¯¯å¤„ç† | 60/100 | æœ‰å›é€€æœºåˆ¶ï¼Œç¼ºä¹é‡è¯•å’Œæ¢å¤ |
| æ–‡æ¡£å®Œæ•´æ€§ | 70/100 | ä»£ç æ³¨é‡Šå……åˆ†ï¼Œç¼ºä¹é›†æˆæ–‡æ¡£ |
| å¯ç»´æŠ¤æ€§ | 75/100 | æ¶æ„æ¸…æ™°ï¼Œç¼ºä¹æµ‹è¯•ä¼šå¢åŠ ç»´æŠ¤é£é™© |
| ç”¨æˆ·ä½“éªŒ | 70/100 | å‘½ä»¤æ¸…æ™°ï¼Œç¼ºä¹é”™è¯¯æ¢å¤äº¤äº’ |
| æ€§èƒ½ | 80/100 | æ”¯æŒç¼“å­˜å’Œé€Ÿç‡é™åˆ¶ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ– |

**ç»¼åˆè¯„åˆ†: 77/100** - æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ä½†éœ€è¦åŠ å¼ºæµ‹è¯•å’Œé”™è¯¯å¤„ç†

---

## å…«ã€åç»­å»ºè®®è¡ŒåŠ¨

### ç«‹å³é‡‡å–è¡ŒåŠ¨ï¼ˆæœ¬å‘¨ï¼‰
1. ä¸º TodoListManager åˆ›å»ºå•å…ƒæµ‹è¯•
2. ä¸ºæ‰€æœ‰è§’è‰²åˆ›å»ºæµ‹è¯•ç”¨ä¾‹
3. æ–‡æ¡£åŒ–å½“å‰æ¶æ„è®¾è®¡

### çŸ­æœŸè®¡åˆ’ï¼ˆæœ¬æœˆï¼‰
1. å®ç°é‡è¯•æœºåˆ¶
2. æ·»åŠ ä¸­æ–‡æ”¯æŒçš„ä»»åŠ¡è·¯ç”±
3. åˆ›å»ºé›†æˆæµ‹è¯•å¥—ä»¶

### ä¸­æœŸè®¡åˆ’ï¼ˆæœ¬å­£åº¦ï¼‰
1. å®ç°ä¸Šä¸‹æ–‡æŒä¹…åŒ–
2. æ·»åŠ ä»»åŠ¡ä¾èµ–ç®¡ç†
3. æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜æ”¹è¿›

---

*æœ¬åˆ†æåŸºäº HarmonySafeAgent æºä»£ç çš„æ·±åº¦å®¡æŸ¥*
