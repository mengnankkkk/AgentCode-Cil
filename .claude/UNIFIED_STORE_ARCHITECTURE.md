# ç»Ÿä¸€é—®é¢˜å­˜å‚¨æ¶æ„ - å®ç°æ€»ç»“

**å®Œæˆæ—¥æœŸ**: 2025-10-26
**å®ç°é˜¶æ®µ**: é˜¶æ®µ1-2ï¼ˆæ ¸å¿ƒåŸºç¡€ + å‘½ä»¤é›†æˆï¼‰

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ”¹é€ å®ç°äº†**ä¸­å¤®é—®é¢˜å­˜å‚¨ï¼ˆUnifiedIssueStoreï¼‰**ç³»ç»Ÿï¼Œç”¨äºæ¶ˆé™¤æ•°æ®å­¤å²›ï¼Œè®©å®‰å…¨åˆ†æå·¥å…·é—´èƒ½å¤Ÿæ„ŸçŸ¥å’Œåä½œã€‚

### æ ¸å¿ƒæ”¹å˜
- **ä»**: æ¯ä¸ªå‘½ä»¤ç‹¬ç«‹ç”ŸæˆæŠ¥å‘Šï¼Œäº’ä¸å…³è”
- **åˆ°**: æ‰€æœ‰å‘½ä»¤æ±‡èšæ•°æ®åˆ°ç»Ÿä¸€ Storeï¼Œæ”¯æŒå»é‡ã€åˆå¹¶ã€æŸ¥è¯¢ã€å¯¼å‡º

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒç»„ä»¶

#### UnifiedIssueStore ï¼ˆæ–°å»ºï¼‰
```
æ ¸å¿ƒå­˜å‚¨æœºåˆ¶ï¼š
- Map<String, SecurityIssue> issues  // ä»¥é—®é¢˜å“ˆå¸Œå€¼ä¸º Key
- Map<String, List<String>> fileIndex  // æ–‡ä»¶ -> é—®é¢˜å“ˆå¸Œåˆ—è¡¨ï¼ˆåŠ é€ŸæŸ¥è¯¢ï¼‰
```

**å…³é”®ç‰¹æ€§**ï¼š
- **å»é‡åˆå¹¶**: åŒä¸€é—®é¢˜ä¸é‡å¤å­˜å‚¨ï¼ˆåŸºäº hashï¼‰
- **æ•°æ®èåˆ**: AIå®¡æŸ¥ç»“æœä¼˜å…ˆçº§é«˜äºSASTï¼ˆé€‰æ‹©"æ›´ä¸°å¯Œ"çš„ç‰ˆæœ¬ï¼‰
- **å¤šç»´æŸ¥è¯¢**: æŒ‰æ–‡ä»¶ã€è¡Œå·èŒƒå›´ã€ä¸¥é‡çº§åˆ«ã€ç±»åˆ«æŸ¥è¯¢
- **å¯¼å‡ºæ”¯æŒ**: è½¬æ¢ä¸º ScanResultï¼Œå¤ç”¨ JsonReportWriter

#### StoreSession ï¼ˆæ–°å»ºï¼‰
```
ä¼šè¯ç®¡ç†ï¼š
- sessionId: UUID å”¯ä¸€æ ‡è¯†
- store: UnifiedIssueStore å®ä¾‹
- createdAt / lastModified: æ—¶é—´æˆ³
- save() / clear(): æŒä¹…åŒ–å’Œæ¸…ç©ºæ“ä½œ
```

**ç”¨é€”**ï¼š
- åœ¨äº¤äº’æ¨¡å¼ä¸­éš”ç¦»å¤šä¸ªä¼šè¯
- æ”¯æŒä¼šè¯çº§åˆ«çš„æŒä¹…åŒ–
- ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

### 2. æ”¹é€ çš„ç°æœ‰ç»„ä»¶

#### AnalysisEngine
```java
// æ–°å¢æ–¹æ³•
public ScanResult analyzeWithStore(UnifiedIssueStore store)
    throws IOException, AnalyzerException
```
- è°ƒç”¨åŸæœ‰ analyze()
- è‡ªåŠ¨å°†ç»“æœå†™å…¥ Store

#### InteractiveCommand
```
æ–°å¢ï¼š
- storeSession: StoreSession å®ä¾‹ï¼ˆä¼šè¯åˆå§‹åŒ–æ—¶åˆ›å»ºï¼‰
- /report å‘½ä»¤å¤„ç†ç¨‹åºï¼ˆç”Ÿæˆç»Ÿä¸€æŠ¥å‘Šï¼‰

æ”¹è¿›ï¼š
- analyze å®Œæˆåæç¤ºä½¿ç”¨ /report
- help ä¸­æ·»åŠ  /report å‘½ä»¤è¯´æ˜
```

---

## ğŸ”„ æ•°æ®æµ

### äº¤äº’æ¨¡å¼å·¥ä½œæµ

```
ç”¨æˆ·è¾“å…¥
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ > /analyze src/                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AnalysisEngine.analyzeWithStore()        â”‚
â”‚ â”œâ”€ æ‰§è¡Œåˆ†æ                              â”‚
â”‚ â”œâ”€ è·å– List<SecurityIssue>              â”‚
â”‚ â””â”€ Store.addIssues(issues)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ > /review src/                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ReviewCommand.reviewFiles()              â”‚
â”‚ â””â”€ (å°†æ¥æ”¹é€ ) Store.addIssues(...)        â”‚
â”‚    [è‡ªåŠ¨å»é‡å’Œåˆå¹¶]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ > /report -o unified.json                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handleReportCommand()                    â”‚
â”‚ â”œâ”€ Store.toScanResult()                  â”‚
â”‚ â”œâ”€ JsonReportWriter.write()              â”‚
â”‚ â””â”€ è¾“å‡ºåˆå¹¶åçš„æŠ¥å‘Š                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å»é‡å’Œåˆå¹¶é€»è¾‘

### Hash ç”Ÿæˆè§„åˆ™
```
hash = "CATEGORY:FILE_PATH:LINE_NUMBER:COLUMN_NUMBER"
ç¤ºä¾‹: "BUFFER_OVERFLOW:src/main.c:42:10"
```

### åˆå¹¶ç­–ç•¥

å½“åŒä¸€é—®é¢˜æ¥è‡ªå¤šä¸ªåˆ†æå™¨æ—¶ï¼š

```
if (newIssue æœ‰ä¿®å¤å»ºè®®) {
    ä½¿ç”¨ newIssueï¼ˆé€šå¸¸æ¥è‡ª AIï¼‰
} else {
    ä¿æŒ existingï¼ˆé€šå¸¸æ¥è‡ª SASTï¼‰
}

è®°å½• merged_from: [analyzer1, analyzer2, ...]
è®°å½• merged_at: åˆå¹¶æ—¶é—´æˆ³
```

---

## ğŸ’¾ å®Œæˆçš„å·¥ä½œæ¸…å•

### âœ… å·²å®Œæˆï¼ˆé˜¶æ®µ1ï¼‰
- [x] UnifiedIssueStore æ ¸å¿ƒç±»
- [x] StoreSession ä¼šè¯ç®¡ç†
- [x] å»é‡å’Œåˆå¹¶é€»è¾‘
- [x] å¤šç»´æŸ¥è¯¢ API
- [x] ScanResult å¯¼å‡º
- [x] ç»Ÿè®¡å’Œè¯Šæ–­

### âœ… å·²å®Œæˆï¼ˆé˜¶æ®µ2ï¼‰
- [x] AnalysisEngine æ”¹é€ ï¼ˆanalyzeWithStoreï¼‰
- [x] InteractiveCommand é›†æˆï¼ˆStoreSessionï¼‰
- [x] /report å‘½ä»¤å®ç°
- [x] å¸®åŠ©ä¿¡æ¯æ›´æ–°

### â³ è¿›è¡Œä¸­ï¼ˆé˜¶æ®µ2ï¼‰
- [ ] ReviewCommand æ·±åº¦é›†æˆï¼ˆéœ€è¦åå°„è·å–ç»“æœï¼‰
- [ ] AnalyzeCommand æ·±åº¦é›†æˆï¼ˆä¼ é€’ Store å¼•ç”¨ï¼‰

### ğŸ“Œ å¾…åšï¼ˆé˜¶æ®µ3ï¼‰
- [ ] AutoFixOrchestrator ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼ˆæŸ¥è¯¢ç›¸é‚»é—®é¢˜ï¼‰
- [ ] RefactorCommand ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼ˆæŸ¥è¯¢å·²çŸ¥æ¼æ´ï¼‰

### ğŸ“Œ å¾…åšï¼ˆé˜¶æ®µ4ï¼‰
- [ ] Store æŒä¹…åŒ–ï¼ˆsave/loadï¼‰
- [ ] ä¼šè¯æ¢å¤ï¼ˆå¯åŠ¨æ—¶åŠ è½½ä¸Šæ¬¡çš„ Storeï¼‰

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### äº¤äº’æ¨¡å¼

```bash
$ java -jar harmony-agent.jar interactive

â¯ /analyze src/main/cpp
ğŸ’¾ åˆ†æç»“æœå·²æ·»åŠ åˆ°ç»Ÿä¸€é—®é¢˜å­˜å‚¨
âœ… Analysis completed - 42 issues found!
ğŸ’¡ ä½¿ç”¨ /report -o report.json ç”Ÿæˆç»Ÿä¸€æŠ¥å‘Š

â¯ /review src/main/cpp
âœ… Code review completed - 15 issues found!

â¯ /report -o unified.json
ç”Ÿæˆç»Ÿä¸€æŠ¥å‘Š
âœ“ JSON æŠ¥å‘Šå·²ç”Ÿæˆ: unified.json
  æ€»é—®é¢˜æ•°: 52 (è‡ªåŠ¨å»é‡: 42+15-5=52)
  ä¸¥é‡é—®é¢˜: 3
  é«˜ä¼˜å…ˆçº§: 8
```

### Store æŸ¥è¯¢ API

```java
UnifiedIssueStore store = session.getStore();

// åŸºç¡€æŸ¥è¯¢
List<SecurityIssue> all = store.getAllIssues();
List<SecurityIssue> critical = store.getIssuesBySeverity(IssueSeverity.CRITICAL);

// æ–‡ä»¶çº§æŸ¥è¯¢
List<SecurityIssue> fileIssues = store.getIssuesByFile("src/main.c");

// èŒƒå›´æŸ¥è¯¢ï¼ˆç”¨äº autofix è·å–ç›¸é‚»é—®é¢˜ï¼‰
List<SecurityIssue> nearby = store.getIssuesInRange("src/main.c", 40, 50);

// ç»Ÿè®¡
Map<IssueSeverity, Long> stats = store.countBySeverity();
```

---

## ğŸ”— é›†æˆç‚¹

### å½“å‰é›†æˆ
1. **AnalysisEngine** â†’ Storeï¼ˆanalyzeWithStoreï¼‰
2. **InteractiveCommand** â†’ StoreSessionï¼ˆä¼šè¯ç®¡ç†ï¼‰
3. **InteractiveCommand** â†’ /reportï¼ˆæŠ¥å‘Šå¯¼å‡ºï¼‰

### é¢„è®¡é›†æˆï¼ˆåç»­ï¼‰
1. **ReviewCommand** â†’ Storeï¼ˆAIå®¡æŸ¥ç»“æœï¼‰
2. **AutoFixOrchestrator** â†’ Storeï¼ˆæŸ¥è¯¢ç›¸é‚»é—®é¢˜ï¼‰
3. **RefactorCommand** â†’ Storeï¼ˆæŸ¥è¯¢å·²çŸ¥æ¼æ´ï¼‰
4. **StoreSession** â†’ Diskï¼ˆä¼šè¯æŒä¹…åŒ–ï¼‰

---

## ğŸ“ å…³é”®ä»£ç ä½ç½®

```
src/main/java/com/harmony/agent/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ store/
â”‚       â”œâ”€â”€ UnifiedIssueStore.java        â† æ ¸å¿ƒå­˜å‚¨
â”‚       â””â”€â”€ StoreSession.java             â† ä¼šè¯ç®¡ç†
â”œâ”€â”€ core/AnalysisEngine.java              â† analyzeWithStore()
â””â”€â”€ cli/InteractiveCommand.java           â† /report å‘½ä»¤ã€StoreSession åˆå§‹åŒ–
```

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

1. **æ•°æ®ä¸€è‡´æ€§**: å•ä¸€çš„çœŸå®æ¥æºï¼ˆSingle Source of Truthï¼‰
2. **çµæ´»æ€§**: æ”¯æŒæ’ä»¶å¼æ·»åŠ æ–°çš„åˆ†æå™¨
3. **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ›´å¤šæŸ¥è¯¢ç»´åº¦
4. **å¯å¤ç”¨æ€§**: å¤ç”¨ç°æœ‰çš„ JsonReportWriterã€ReportGenerator
5. **æ— ç ´åæ€§**: å‘åå…¼å®¹ç°æœ‰å‘½ä»¤ï¼ˆå¯é€‰ç‰¹æ€§ï¼‰
6. **å¹¶å‘å®‰å…¨**: ä½¿ç”¨ ConcurrentHashMap å’Œ synchronized

---

## ğŸ› ï¸ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
- [ ] ReviewCommand å®Œå…¨é›†æˆ
- [ ] AnalyzeCommand å®Œå…¨é›†æˆï¼ˆç›´æ¥ä¼ é€’ Store å¼•ç”¨ï¼‰
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] AutoFixOrchestrator ä¸Šä¸‹æ–‡æ„ŸçŸ¥

### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰
- [ ] ä¼šè¯æŒä¹…åŒ–å®ç°
- [ ] RefactorCommand ä¸Šä¸‹æ–‡æ„ŸçŸ¥
- [ ] UI/æŠ¥å‘Šå¯è§†åŒ–æ”¹è¿›
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆä¸‡çº§åˆ«é—®é¢˜çš„æŸ¥è¯¢æ€§èƒ½ï¼‰

### é•¿æœŸï¼ˆ1ä¸ªæœˆ+ï¼‰
- [ ] å¤šä¼šè¯ç®¡ç†ç•Œé¢
- [ ] é—®é¢˜å†å²è¿½è¸ª
- [ ] åˆå¹¶éªŒè¯æœºåˆ¶ï¼ˆç¡®ä¿åˆå¹¶å‰åçš„æ•°æ®ä¸€è‡´æ€§ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- Architecture Design: è§æœ¬æ–‡æ¡£
- API Reference: UnifiedIssueStore ç±»çš„ JavaDoc
- Usage Guide: è§ InteractiveCommand.handleReportCommand() çš„è¯´æ˜

---

**çŠ¶æ€**: ğŸŸ¢ å¯ç”¨äºé›†æˆæµ‹è¯•
**å…¼å®¹æ€§**: å®Œå…¨å‘åå…¼å®¹
**æµ‹è¯•è¦†ç›–**: å¾…è¡¥å……å•å…ƒæµ‹è¯•
